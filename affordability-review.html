<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affordability Assessment</title>
  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url("https://github.com/craigmalenga/affordability-frontend/blob/main/Background.png?raw=true") no-repeat center center fixed;
      background-size: cover;
    }
    #errorContainer, #bankWarningsDiv, #timerOverrideDiv {
      width: 100%;
    }
    #errorContainer {
      margin-bottom: 20px;
    }
  </style>

  <script>
    let TIMER_CONFIG = {};
    fetch('./timer_config.json')
      .then(response => response.json())
      .then(config => { TIMER_CONFIG = config; })
      .catch(err => {
        console.error("Failed to load timer_config.json:", err);
        alert("Critical error: Timer configuration file could not be loaded.");
      });

    const categories = [
      "Income",
      "Rent/Mortgage",
      "Council Tax",
      "Utilities",
      "Credit Commitments",
      "Gambling Expenditure"
    ];

    let dynamicMonths = [];
    let statements = [];
    let priorInputData = "";
    let overrides = [];
    let timerOverrideAcknowledged = false;
    let startTime = null;
    let timerInterval = null;
    let totalTimeSpentSeconds = 0;

    function updateTimerDisplay() {
      if (!startTime) return;
      const diffSec = Math.floor((new Date() - startTime) / 1000);
      const hh = Math.floor(diffSec / 3600).toString().padStart(1, '0');
      const mm = Math.floor((diffSec % 3600) / 60).toString().padStart(2, '0');
      const ss = (diffSec % 60).toString().padStart(2, '0');
      document.getElementById("timerDisplay").innerText = `Timer: ${hh}:${mm}:${ss}`;
    }

    function startTimer() {
      startTime = new Date();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      totalTimeSpentSeconds = Math.floor((new Date() - startTime) / 1000);
      return totalTimeSpentSeconds;
    }

    function formatNumericValue(num) {
      return num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function saveData(statementIndex, rowIndex, monthIndex) {
      const inputId = `${statementIndex}_${rowIndex}_${monthIndex}`;
      const inputElem = document.getElementById(inputId);
      let val = parseFloat(inputElem.value.replace(/,/g, ''));
      if (isNaN(val)) val = 0;
      statements[statementIndex].data[`${rowIndex}_${monthIndex}`] = val;
      inputElem.value = formatNumericValue(val);
      const cb = document.getElementById("override_" + statementIndex);
      if (cb && cb.checked) {
        cb.checked = false;
        overrides[statementIndex] = false;
        checkAllOverrides();
      }
    }

    function resetForm() {
      document.getElementById("fullName").value = "";
      document.getElementById("bankNames").value = "";
      document.getElementById("statement_urls").value = "";
      document.getElementById("periodCovered").value = "";
      document.getElementById("monthlyRepayment").value = "";
      document.getElementById("statementForm").innerHTML = "";
      document.getElementById("bankStatements").innerHTML = "";
      document.getElementById("errorContainer").innerHTML = "";
      statements = [];
      overrides = [];
      priorInputData = "";
      timerOverrideAcknowledged = false;
      clearInterval(timerInterval);
      startTime = null;
      totalTimeSpentSeconds = 0;
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = true;
      processBtn.style.backgroundColor = "red";
    }

    function fetchLeadData() {
      resetForm();
      const leadId = document.getElementById("leadId").value.trim();
      if (!leadId) { alert("Please enter a valid Lead ID."); return; }
      startTimer();
      fetch(`https://web-production-15e92.up.railway.app/api/flg_data/${leadId}`, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          if (data.error) { alert(data.error); return; }
          document.getElementById("fullName").value = data.fullName || "";
          document.getElementById("bankNames").value = data.bankNames.split(",").join("\n");
          document.getElementById("statement_urls").value = data.statement_urls.split(",").join("\n");
          document.getElementById("periodCovered").value = data.periodCovered || "";
          document.getElementById("monthlyRepayment").value = data.monthlyRepayment || "";
          dynamicMonths = data.monthsForTable.length === 3 ? data.monthsForTable : ["N/A","N/A","N/A"];

          const bankNamesArr = data.bankNames.split(",").filter(Boolean);
          const statementUrlsArr = data.statement_urls.split(",").filter(Boolean);
          if (bankNamesArr.length !== statementUrlsArr.length) {
            alert("Mismatch between number of bank names and statement URLs."); return;
          }
          statements = bankNamesArr.map((bank, index) => ({
            bank: bank,
            file: statementUrlsArr[index],
            entered: false,
            prepopulated: false,
            data: {}
          }));
          createStatementLinks();

          if (data.inputData.trim() !== "") {
            priorInputData = data.inputData.trim();
            createLoadPriorButton();
          }
        })
        .catch(err => { alert("Failed to fetch data from FLG."); });
    }

    function createStatementLinks() {
      const pdfContainer = document.getElementById("bankStatements");
      pdfContainer.innerHTML = "";
      statements.forEach((statement, index) => {
        const container = document.createElement("div");
        container.classList.add("mb-4");
        const viewLink = document.createElement("a");
        viewLink.href = statement.file;
        viewLink.innerText = `View ${statement.bank} statement`;
        viewLink.classList.add("text-blue-500", "underline");
        viewLink.onclick = (e) => { e.preventDefault(); window.open(statement.file, "_blank"); };
    
        const btnContainer = document.createElement("div");
        btnContainer.classList.add("ml-4", "mt-2", "flex", "items-center");
    
        const enterDataBtn = document.createElement("button");
        enterDataBtn.id = "enterDataBtn_" + index;
        enterDataBtn.innerText = "Enter Data";
        enterDataBtn.classList.add("bg-blue-600", "text-white", "px-4", "py-2", "rounded-md");
        enterDataBtn.onclick = () => loadStatementForm(index);
    
        const tickSpan = document.createElement("span");
        tickSpan.id = "tick_" + index;
        tickSpan.classList.add("ml-2", "font-bold");
    
        btnContainer.appendChild(enterDataBtn);
        btnContainer.appendChild(tickSpan);
    
        container.appendChild(viewLink);
        container.appendChild(btnContainer);
        pdfContainer.appendChild(container);
      });
    }
    
    function createLoadPriorButton() {
      const bankStatementsDiv = document.getElementById("bankStatements");
      const loadPriorBtn = document.createElement("button");
      loadPriorBtn.id = "loadPriorBtn";
      loadPriorBtn.innerText = "Option: load prior input data statement categorisation";
      loadPriorBtn.classList.add("bg-green-600", "text-white", "px-4", "py-2", "rounded-md", "w-full");
      loadPriorBtn.onclick = loadPriorInputData;
      bankStatementsDiv.appendChild(loadPriorBtn);
    }
    
    function loadStatementForm(statementIndex) {
      const statement = statements[statementIndex];
      const formContainer = document.getElementById("statementForm");
      formContainer.innerHTML = `<h3 class='text-lg font-bold mt-6'>${statement.bank} Statement Data</h3>`;
      let table = `<table class='w-full border-collapse border border-gray-300 mt-4'><tr><th class='border p-2'>Category</th>`;
      dynamicMonths.forEach(month => { table += `<th class='border p-2'>${month}</th>`; });
      table += "</tr>";
    
      categories.forEach((category, rowIndex) => {
        table += `<tr><td class='border p-2 font-semibold'>${category}</td>`;
        dynamicMonths.forEach((_, monthIndex) => {
          const rawVal = statement.data[`${rowIndex}_${monthIndex}`] || 0;
          const displayVal = formatNumericValue(rawVal);
          table += `<td class='border p-2'><input type='text' id='${statementIndex}_${rowIndex}_${monthIndex}' class='border p-2 w-full rounded-md text-right' value="${displayVal}" onblur="saveData(${statementIndex}, ${rowIndex}, ${monthIndex})"></td>`;
        });
        table += "</tr>";
      });
      table += `</table>`;
      table += `<button onclick='summarizeData(${statementIndex})' class='mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 w-full'>Upload data for this bank to summary before processing</button>`;
      formContainer.innerHTML = table;
    }
    function summarizeData(statementIndex) {
      document.getElementById("errorContainer").innerHTML = "";
      let summary = `<h3 class='text-lg font-bold mt-6'>Summary Across Banks</h3>`;
      summary += `<table class='w-full border-collapse border border-gray-300 mt-4'><tr><th class='border p-2'>Category</th>`;
      dynamicMonths.forEach(m => summary += `<th class='border p-2'>${m}</th>`);
      summary += `<th class='border p-2'>Average</th></tr>`;
    
      categories.forEach((category, rowIndex) => {
        summary += `<tr><td class='border p-2 font-semibold'>${category}</td>`;
        let monthTotals = [];
        dynamicMonths.forEach((_, monthIndex) => {
          let total = 0;
          statements.forEach(st => { total += st.data[`${rowIndex}_${monthIndex}`] || 0; });
          monthTotals.push(total);
          summary += `<td class='border p-2 font-bold text-right'>${formatNumericValue(total)}</td>`;
        });
        const avg = monthTotals.reduce((a, b) => a + b, 0) / dynamicMonths.length;
        summary += `<td class='border p-2 font-bold text-right'>${formatNumericValue(avg)}</td></tr>`;
      });
      summary += `</table>`;
    
      document.getElementById("statementForm").innerHTML = summary;
      const btnContainer = document.querySelectorAll("#bankStatements .btn-container")[statementIndex];
      const enterDataBtn = btnContainer.querySelector("button");
      enterDataBtn.innerText = "Edit Data";
      enterDataBtn.style.backgroundColor = "green";
      const tickSpan = document.getElementById("tick_" + statementIndex);
      tickSpan.innerText = "âœ”";
      tickSpan.style.color = "green";
      statements[statementIndex].entered = true;
      checkProcessButton();
    }
    
    function checkProcessButton() {
      const allEntered = statements.every(statement => statement.entered);
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = !allEntered;
      processBtn.style.backgroundColor = allEntered ? "green" : "red";
    }
    
    function loadPriorInputData() {
      if (!priorInputData) { alert("No prior input data available."); return; }
      const fields = priorInputData.split(",").map(f => f.trim());
      const groupSize = 19;
      for (let i = 0; i < fields.length; i += groupSize) {
        const group = fields.slice(i, i + groupSize);
        if (group.length < groupSize) continue;
        const bankNameFromData = group[0];
        const foundIndex = statements.findIndex(s => s.bank.toLowerCase() === bankNameFromData.toLowerCase());
        if (foundIndex !== -1) {
          statements[foundIndex].prepopulated = true;
          for (let row = 0; row < categories.length; row++) {
            for (let month = 0; month < 3; month++) {
              const fieldIndex = 1 + (row * 3) + month;
              let val = parseFloat(group[fieldIndex].replace(/,/g, ''));
              if (isNaN(val)) val = 0;
              statements[foundIndex].data[`${row}_${month}`] = val;
              const inputElem = document.getElementById(`${foundIndex}_${row}_${month}`);
              if (inputElem) { inputElem.value = formatNumericValue(val); }
            }
          }
          const btn = document.getElementById(`enterDataBtn_${foundIndex}`);
          if (btn) {
            btn.innerText = "Review Data";
            btn.classList.remove("bg-blue-600", "text-white");
            btn.classList.add("bg-yellow-400", "text-white");
          }
        }
      }
      alert("Prior input data loaded for matching bank accounts.");
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
    });
    
    </script>
    </head>
    <body class="bg-gray-100 p-6">
      <div class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg">
        <div class="flex justify-between items-center mb-4">
          <button onclick="window.location.href='https://affordability-review-main-menu.up.railway.app/'" class="bg-gray-500 text-white px-4 py-2 rounded-md">Return to Main Menu</button>
          <button onclick="window.location.href='https://web-production-15e92.up.railway.app/login'" class="bg-red-600 text-white px-4 py-2 rounded-md">Log in with Microsoft 365</button>
        </div>
    
        <div class="text-center mb-4">
          <img src="https://github.com/craigmalenga/Image_belmond_Frontend/blob/main/Belmond%20logo.png?raw=true" alt="Company Logo" class="h-16 mx-auto mb-2"/>
          <h1 class="text-2xl font-bold">Affordability Assessment</h1>
        </div>
    
        <label class="block font-medium">Enter Lead ID:</label>
        <div class="flex gap-2 mt-2">
          <input id="leadId" class="border p-2 flex-1 rounded-md text-gray-600"/>
          <button onclick="fetchLeadData()" id="fetchDataBtn" class="bg-gray-400 text-white px-4 py-2 rounded-md">Fetch Data</button>
        </div>
    
        <div id="timerDisplay" class="mt-4 font-semibold">Timer: 0:00:00</div>
    
        <h2 class="text-lg font-semibold mt-6">Lead Details</h2>
        <input id="fullName" class="border p-2 w-full rounded-md bg-gray-200" readonly />
        <textarea id="bankNames" class="border p-2 w-full rounded-md bg-gray-200 mt-2" rows="3" readonly></textarea>
        <input id="periodCovered" class="border p-2 w-full rounded-md bg-gray-200" readonly />
        <textarea id="statement_urls" class="border p-2 w-full rounded-md bg-gray-200" rows="3" readonly></textarea>
        <input type="number" id="monthlyRepayment" class="border p-2 w-full rounded-md bg-gray-200" readonly />
    
        <h2 class="text-lg font-semibold mt-6">Bank Statements</h2>
        <div id="bankStatements" class="mt-2"></div>
        <div id="statementForm"></div>
        <div id="errorContainer" class="w-full"></div>
    
        <button id="processDataBtn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md w-full" disabled onclick="processFinalData()">Process Data</button>
    
      </div>
    </body>
    </html>
    



