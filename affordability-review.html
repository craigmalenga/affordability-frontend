<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affordability Assessment</title>
  
  <!-- Favicon snippets -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url("https://github.com/craigmalenga/affordability-frontend/blob/main/Background.png?raw=true") no-repeat center center fixed;
      background-size: cover;
    }
    /* Containers for warnings and errors take full width */
    #errorContainer, #bankWarningsDiv, #timerOverrideDiv {
      width: 100%;
    }
    #errorContainer {
      margin-bottom: 20px;
    }
    /* Simple modal for fetch errors */
    #fetchErrorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fefefe;
      border: 2px solid #e3342f;
      padding: 20px;
      z-index: 1000;
      text-align: center;
    }
    /* Overlay for modal */
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 900;
    }
    /* Summary table styling */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }
    .summary-table th,
    .summary-table td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .summary-table th {
      text-align: left;
      background-color: #f9f9f9;
    }
  </style>
  
  <script>
    /*************************************
     * Force Logout on Page Load to Require Re‑Login
     *************************************/
    function forceLogout() {
      fetch("https://web-production-15e92.up.railway.app/logout", { credentials: 'include' })
        .then(() => console.log("Forced logout"))
        .catch(err => console.error("Error during forced logout:", err));
    }
    
    /*************************************
     * Load Timer Configuration from External JSON
     *************************************/
    let TIMER_CONFIG = {};
    fetch('./timer_config.json')
      .then(response => response.json())
      .then(config => { TIMER_CONFIG = config; })
      .catch(err => {
        console.error("Failed to load timer_config.json:", err);
        alert("Critical error: Timer configuration file could not be loaded.");
      });
    
    /*************************************
     * Global Variables and Categories (6 rows only)
     *************************************/
    // Categories: row 0 = Income; rows 1-4 = Expenses; row 5 = Gambling
    const categories = [
      "Income",
      "Rent/Mortgage",
      "Council Tax",
      "Utilities",
      "Credit Commitments",
      "Gambling Expenditure"
    ];
    
    let dynamicMonths = []; // Expected to have 3 values
    let statements = [];    // Each bank object with data: keys "0_0", etc.
    let priorInputData = "";
    let overrides = [];
    let timerOverrideAcknowledged = false;
    let startTime = null;
    let timerInterval = null;
    let totalTimeSpentSeconds = 0;
    
    /*************************************
     * Timer Functions
     *************************************/
    function updateTimerDisplay() {
      if (!startTime) return;
      const diffSec = Math.floor((new Date() - startTime) / 1000);
      const hh = Math.floor(diffSec / 3600).toString().padStart(1, '0');
      const mm = Math.floor((diffSec % 3600) / 60).toString().padStart(2, '0');
      const ss = (diffSec % 60).toString().padStart(2, '0');
      document.getElementById("timerDisplay").innerText = `Timer: ${hh}:${mm}:${ss}`;
    }
    function startTimer() {
      startTime = new Date();
      updateTimerDisplay();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      totalTimeSpentSeconds = Math.floor((new Date() - startTime) / 1000);
      return totalTimeSpentSeconds;
    }
    
    /*************************************
     * Numeric Formatting
     *************************************/
    function formatNumericValue(num) {
      return num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    /*************************************
     * Save Data Function (on blur)
     *************************************/
    function saveData(statementIndex, rowIndex, monthIndex) {
      const inputId = `${statementIndex}_${rowIndex}_${monthIndex}`;
      const inputElem = document.getElementById(inputId);
      let val = parseFloat(inputElem.value.replace(/,/g, ''));
      if (isNaN(val)) { val = 0; }
      statements[statementIndex].data[`${rowIndex}_${monthIndex}`] = val;
      inputElem.value = formatNumericValue(val);
      // Do not mark bank complete until "upload" button is pressed.
      const cb = document.getElementById("override_" + statementIndex);
      if (cb && cb.checked) {
        cb.checked = false;
        overrides[statementIndex] = false;
        checkAllOverrides();
      }
    }
    
    /*************************************
     * Reset Form Function
     *************************************/
    function resetForm() {
      document.getElementById("fullName").value = "";
      document.getElementById("bankNames").value = "";
      document.getElementById("statement_urls").value = "";
      document.getElementById("periodCovered").value = "";
      document.getElementById("monthlyRepayment").value = "";
      document.getElementById("statementForm").innerHTML = "";
      document.getElementById("bankStatements").innerHTML = "";
      document.getElementById("errorContainer").innerHTML = "";
      statements = [];
      overrides = [];
      priorInputData = "";
      timerOverrideAcknowledged = false;
      if (timerInterval) { clearInterval(timerInterval); }
      startTime = null;
      totalTimeSpentSeconds = 0;
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
      // Keep the button label "Process Data"
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = true;
      processBtn.style.backgroundColor = "red";
    }
    
    /*************************************
     * Fetch Lead Data Function
     *************************************/
    function fetchLeadData() {
      resetForm();
      const leadId = document.getElementById("leadId").value.trim();
      if (!leadId) { alert("Please enter a valid Lead ID."); return; }
      startTimer();
      fetch(`https://web-production-15e92.up.railway.app/api/flg_data/${leadId}`, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          // Only proceed if there is no error property.
          if (data.error) { 
            showFetchError(data.error);
            return;
          }
          document.getElementById("fullName").value = data.fullName || "";
          document.getElementById("bankNames").value = data.bankNames ? data.bankNames.split(",").map(n => n.trim()).join("\n") : "";
          document.getElementById("statement_urls").value = data.statement_urls ? data.statement_urls.split(",").map(u => u.trim()).join("\n") : "";
          document.getElementById("periodCovered").value = data.periodCovered || "";
          document.getElementById("monthlyRepayment").value = data.monthlyRepayment || "";
          dynamicMonths = (data.monthsForTable && data.monthsForTable.length === 3) ? data.monthsForTable : ["N/A", "N/A", "N/A"];
    
          const bankNamesArr = data.bankNames ? data.bankNames.split(",").map(n => n.trim()).filter(Boolean) : [];
          const statementUrlsArr = data.statement_urls ? data.statement_urls.split(",").map(u => u.trim()).filter(Boolean) : [];
          if (bankNamesArr.length !== statementUrlsArr.length) {
            alert("Mismatch between number of bank names and statement URLs.");
            return;
          }
          statements = bankNamesArr.map((bank, index) => ({
            bank: bank,
            file: statementUrlsArr[index],
            entered: false,  // Will be set to true only after "Upload data…" is clicked.
            prepopulated: false,
            data: {}
          }));
          createStatementLinks();
    
          if (data.inputData && data.inputData.trim() !== "") {
            priorInputData = data.inputData.trim();
            createLoadPriorButton();
          }
        })
        .catch(err => { 
          console.error("Error fetching FLG data:", err);
          showFetchError("Failed to fetch data from FLG. Check console for details.");
        });
    }
    
    // Show fetch error in a centered modal
    function showFetchError(message) {
      const overlay = document.getElementById("modalOverlay");
      const modal = document.getElementById("fetchErrorModal");
      modal.innerText = message;
      overlay.style.display = "block";
      modal.style.display = "block";
    }
    function hideFetchError() {
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("fetchErrorModal").style.display = "none";
    }
    
    /*************************************
     * Create Statement Links Function
     *************************************/
    function createStatementLinks() {
      const pdfContainer = document.getElementById("bankStatements");
      pdfContainer.innerHTML = "";
      statements.forEach((statement, index) => {
        const container = document.createElement("div");
        container.classList.add("mb-4");
        const viewLink = document.createElement("a");
        viewLink.href = statement.file;
        viewLink.innerText = `View ${statement.bank} statement`;
        viewLink.classList.add("text-blue-500", "underline", "cursor-pointer");
        viewLink.onclick = (e) => { e.preventDefault(); window.open(statement.file, "_blank"); };
    
        const btnContainer = document.createElement("div");
        btnContainer.classList.add("btn-container", "ml-4", "mt-2", "flex", "items-center");
    
        const enterDataBtn = document.createElement("button");
        enterDataBtn.id = "enterDataBtn_" + index;
        enterDataBtn.innerText = "Enter Data";
        enterDataBtn.classList.add("bg-blue-600", "text-white", "px-4", "py-2", "rounded-md");
        enterDataBtn.onclick = () => loadStatementForm(index);
    
        const tickSpan = document.createElement("span");
        tickSpan.id = "tick_" + index;
        tickSpan.classList.add("ml-2", "font-bold");
        tickSpan.innerText = "";
    
        btnContainer.appendChild(enterDataBtn);
        btnContainer.appendChild(tickSpan);
    
        container.appendChild(viewLink);
        container.appendChild(btnContainer);
        pdfContainer.appendChild(container);
      });
    }
    
    /*************************************
     * Create Load Prior Input Button
     *************************************/
    function createLoadPriorButton() {
      if (document.getElementById("loadPriorBtn")) return;
      const bankStatementsDiv = document.getElementById("bankStatements");
      const loadPriorBtnContainer = document.createElement("div");
      loadPriorBtnContainer.classList.add("mb-4");
      const loadPriorBtn = document.createElement("button");
      loadPriorBtn.id = "loadPriorBtn";
      loadPriorBtn.innerText = "Option: load prior input data statement categorisation";
      loadPriorBtn.classList.add("bg-green-600", "text-white", "px-4", "py-2", "rounded-md", "block", "w-full");
      loadPriorBtn.onclick = loadPriorInputData;
      loadPriorBtnContainer.appendChild(loadPriorBtn);
      bankStatementsDiv.appendChild(loadPriorBtnContainer);
    }
    
    /*************************************
     * Load Statement Form for a Bank
     *************************************/
    function loadStatementForm(statementIndex) {
      const statement = statements[statementIndex];
      const formContainer = document.getElementById("statementForm");
      formContainer.innerHTML = `<h3 class='text-lg font-bold mt-6'>${statement.bank} Statement Data</h3>`;
      let table = `<table class='w-full border-collapse border border-gray-300 mt-4'><tr><th class='border p-2'>Category</th>`;
      dynamicMonths.forEach(month => { table += `<th class='border p-2'>${month}</th>`; });
      table += "</tr>";
    
      categories.forEach((category, rowIndex) => {
        table += `<tr><td class='border p-2 font-semibold'>${category}</td>`;
        dynamicMonths.forEach((_, monthIndex) => {
          const rawVal = statement.data[`${rowIndex}_${monthIndex}`] || 0;
          const displayVal = formatNumericValue(rawVal);
          table += `<td class='border p-2'><input type='number' id='${statementIndex}_${rowIndex}_${monthIndex}' class='border p-2 w-full rounded-md text-right' value="${displayVal}" onblur="saveData(${statementIndex}, ${rowIndex}, ${monthIndex})"></td>`;
        });
        table += "</tr>";
      });
      table += `</table>`;
      // This button marks the bank's data as "uploaded" (which sets its entered flag)
      table += `<button onclick='uploadBankData(${statementIndex})' class='mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 w-full'>Upload data for this bank to summary before processing</button>`;
      formContainer.innerHTML = table;
    }
    
    // Called when the user clicks "Upload data..." for a bank.
    function uploadBankData(statementIndex) {
      // Mark this bank as complete.
      statements[statementIndex].entered = true;
      // Change button state to indicate completion.
      const btnContainer = document.querySelectorAll("#bankStatements .btn-container")[statementIndex];
      const enterDataBtn = btnContainer.querySelector("button");
      enterDataBtn.innerText = "Edit Data";
      enterDataBtn.style.backgroundColor = "green";
      const tickSpan = document.getElementById("tick_" + statementIndex);
      tickSpan.innerText = "✔";
      tickSpan.style.color = "green";
      checkProcessButton();
    }
    
    /*************************************
     * Check Process Button State
     *************************************/
    function checkProcessButton() {
      // Enable "Process Data" only if ALL banks have been uploaded.
      const allEntered = statements.every(statement => statement.entered);
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = !allEntered;
      processBtn.style.backgroundColor = allEntered ? "green" : "red";
    }
    
    /*************************************
     * Calculate Averages, Analysis, and Build Summary/Decision UI
     *************************************/
    function calculateAveragesAndDecision() {
      const nBanks = statements.length;
      const nMonths = dynamicMonths.length;
      let totalIncome = 0, totalExpenses = 0, totalGambling = 0;
      
      // Sum across each bank and each month.
      statements.forEach(statement => {
        for (let m = 0; m < nMonths; m++) {
          const income = parseFloat(statement.data[`0_${m}`]) || 0;
          totalIncome += income;
          let expenses = 0;
          for (let r = 1; r <= 4; r++) {
            expenses += parseFloat(statement.data[`${r}_${m}`]) || 0;
          }
          totalExpenses += expenses;
          const gambling = parseFloat(statement.data[`5_${m}`]) || 0;
          totalGambling += gambling;
        }
      });
      
      const avgIncome = totalIncome / (nBanks * nMonths);
      const avgExpenses = totalExpenses / (nBanks * nMonths);
      const avgGambling = totalGambling / (nBanks * nMonths);
      const avgDisposableIncome = avgIncome - avgExpenses + avgGambling;
      
      // Calculate percentages (with safe division)
      const gamblingAsIncomePercent = avgIncome > 0 ? (avgGambling / avgIncome) * 100 : 0;
      const gamblingAsDisposableIncomePercent = avgDisposableIncome > 0 ? (avgGambling / avgDisposableIncome) * 100 : 0;
      const monthlyRepayment = parseFloat(document.getElementById("monthlyRepayment").value) || 0;
      const loanRepaymentPercent = avgDisposableIncome > 0 ? (monthlyRepayment / avgDisposableIncome) * 100 : 0;
      
      // Build summary table (2 columns: label and value)
      let summaryHTML = `
        <div class="bg-white p-4 mt-6 shadow-md">
          <h3 class="text-xl font-bold mb-4">Calculated Averages and Analysis</h3>
          <table class="summary-table">
            <tr>
              <th>Average Income</th>
              <td>£${formatNumericValue(avgIncome)} per month</td>
            </tr>
            <tr>
              <th>Average Expenses (excl. gambling)</th>
              <td>£${formatNumericValue(avgExpenses)} per month</td>
            </tr>
            <tr>
              <th>Average Gambling</th>
              <td>£${formatNumericValue(avgGambling)} per month</td>
            </tr>
            <tr>
              <th>Average Disposable Income</th>
              <td>£${formatNumericValue(avgDisposableIncome)} per month</td>
            </tr>
            <tr>
              <th>Gambling as % of Income</th>
              <td>${formatNumericValue(gamblingAsIncomePercent)}%</td>
            </tr>
            <tr>
              <th>Gambling as % of Disposable Income</th>
              <td>${formatNumericValue(gamblingAsDisposableIncomePercent)}%</td>
            </tr>
            <tr>
              <th>Loan Repayments as % of Disposable Income</th>
              <td>${formatNumericValue(loanRepaymentPercent)}%</td>
            </tr>
          </table>
        </div>
      `;
      
      // Build warnings section (if any warnings exist)
      let warningsHTML = "";
      let bankWarnings = "";
      let problemMonths = [];
      // Check each month for issues
      const months = dynamicMonths;
      let sumIncome = Array(nMonths).fill(0), sumExpenses = Array(nMonths).fill(0);
      statements.forEach(st => {
        for (let m = 0; m < nMonths; m++) {
          const inc = parseFloat(st.data[`0_${m}`]) || 0;
          sumIncome[m] += inc;
          let exp = 0;
          for (let r = 1; r <= 4; r++) {
            exp += parseFloat(st.data[`${r}_${m}`]) || 0;
          }
          sumExpenses[m] += exp;
        }
      });
      for (let i = 0; i < nMonths; i++) {
        if (sumExpenses[i] > sumIncome[i]) {
          problemMonths.push(months[i]);
        }
        if (sumIncome[i] === 0 && sumExpenses[i] === 0) {
          bankWarnings += `No income or expenses entered for month ${months[i]} (possibly incomplete data).<br/>`;
        } else if (sumIncome[i] === 0) {
          bankWarnings += `No income entered for month ${months[i]} (possibly incomplete data).<br/>`;
        } else if (sumExpenses[i] === 0) {
          bankWarnings += `No expenses entered for month ${months[i]} (possibly incomplete data).<br/>`;
        }
      }
      if (problemMonths.length > 0) {
        if (problemMonths.length === 1) {
          bankWarnings += `Expenses exceed income for month ${problemMonths[0]}.<br/>`;
        } else if (problemMonths.length === 2) {
          bankWarnings += `Expenses exceed income for months ${problemMonths[0]} and ${problemMonths[1]}.<br/>`;
        } else {
          bankWarnings += `Expenses exceed income for months ${problemMonths.join(", ")}.<br/>`;
        }
      }
      if (bankWarnings) {
        warningsHTML += `<div id="bankWarningsDiv" class="border border-red-400 bg-red-100 text-red-700 px-4 py-3 rounded mt-4">
                             <strong class="font-bold">Please review your entries:</strong><br/>
                             ${bankWarnings}
                           </div>`;
        // Render override checkboxes for bank warnings
        renderOverrideCheckboxes();
      }
      
      // Stop timer and render timer override box
      const totalSec = stopTimer();
      let nBanksManual = statements.filter(st => !st.prepopulated).length;
      if (nBanksManual < 1) { nBanksManual = 1; }
      const timePerBank = (totalSec / 60) / nBanksManual;
      let timerHTML = `<div id="timerOverridePlaceholder" class="mt-4"></div>`;
      // Append warnings and timer box together after the summary
      let warningsAndTimer = warningsHTML + timerHTML;
      
      // Render timer override box into its placeholder
      document.getElementById("errorContainer").innerHTML = warningsAndTimer;
      renderTimerOverrideBox(timePerBank);
      
      // Build decision box (blue box with bold decision header)
      let affordabilityDecision = "";
      let decisionReason = "";
      if (gamblingAsIncomePercent > 15) {
        affordabilityDecision = "Unaffordable";
        decisionReason = "Gambling exceeds 15% of income, indicating financial risk.";
      } else if (gamblingAsIncomePercent >= 10 && gamblingAsIncomePercent <= 14 && loanRepaymentPercent > 50) {
        affordabilityDecision = "Unaffordable";
        decisionReason = "Gambling between 10–14% and repayment exceeds 50% of disposable income.";
      } else if (gamblingAsIncomePercent < 10 && loanRepaymentPercent > 65) {
        affordabilityDecision = "Unaffordable";
        decisionReason = "Gambling is below 10%, but repayment cost is over 65% of disposable income.";
      } else {
        affordabilityDecision = "Affordable";
        decisionReason = "Neither gambling nor repayment costs indicate financial distress.";
      }
      
      let decisionHTML = `
        <div class="bg-blue-100 border border-blue-400 text-blue-800 p-4 rounded mt-4">
          <h4 class="font-bold text-lg">Decision: ${affordabilityDecision}</h4>
          <p>${decisionReason}</p>
        </div>
      `;
      
      // Build "Process Decision" area with three options and final submit button
      let processDecisionHTML = `
        <div class="bg-gray-50 p-4 mt-4 border rounded">
          <h4 class="font-bold mb-2">Process Decision</h4>
          <div class="mb-2">
            <label class="inline-flex items-center">
              <input type="radio" name="decisionOption" value="default" onchange="checkDecisionOptions()" class="form-radio h-5 w-5 text-green-600">
              <span class="ml-2">Submit in line with decision above</span>
            </label>
          </div>
          <div class="mb-2">
            <label class="inline-flex items-center">
              <input type="radio" name="decisionOption" value="override" onchange="checkDecisionOptions()" class="form-radio h-5 w-5 text-green-600">
              <span class="ml-2">Override and submit as affordable/unaffordable</span>
            </label>
          </div>
          <div class="mb-2">
            <label class="inline-flex items-center">
              <input type="radio" name="decisionOption" value="review" onchange="checkDecisionOptions()" class="form-radio h-5 w-5 text-green-600">
              <span class="ml-2">More information required</span>
            </label>
          </div>
          <div id="reviewCommentContainer" class="mt-2" style="display:none;">
            <label class="block mb-1 font-medium">Please enter reason for review:</label>
            <input type="text" id="reviewComment" class="border p-2 w-full rounded-md" placeholder="Enter reason here">
          </div>
          <button id="finalSubmitBtn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md w-full" disabled onclick="finalSubmitDecision()">Submit Decision</button>
        </div>
      `;
      
      // Combine summary, warnings/timer, decision, and process decision into one UI block.
      const combinedHTML = summaryHTML + decisionHTML + processDecisionHTML;
      document.getElementById("statementForm").innerHTML = combinedHTML;
      
      // Change "Process Data" button text back to "Process Data" (if still visible)
      const processBtn = document.getElementById("processDataBtn");
      processBtn.innerText = "Process Data";
    }
    
    /*************************************
     * Check Decision Options (for enabling final submit)
     *************************************/
    function checkDecisionOptions() {
      const decisionOptions = document.getElementsByName("decisionOption");
      let selected = "";
      for (let opt of decisionOptions) {
        if (opt.checked) {
          selected = opt.value;
          break;
        }
      }
      const reviewContainer = document.getElementById("reviewCommentContainer");
      const finalSubmitBtn = document.getElementById("finalSubmitBtn");
      if (selected === "review") {
        reviewContainer.style.display = "block";
      } else {
        reviewContainer.style.display = "none";
      }
      if (selected === "review") {
        const comment = document.getElementById("reviewComment").value.trim();
        finalSubmitBtn.disabled = (comment === "");
      } else {
        finalSubmitBtn.disabled = (selected === "");
      }
    }
    
    function checkReviewComment() {
      checkDecisionOptions();
    }
    
    /*************************************
     * Final Submit Decision Function
     *************************************/
    function finalSubmitDecision() {
      const decisionOptions = document.getElementsByName("decisionOption");
      let selected = "";
      for (let opt of decisionOptions) {
        if (opt.checked) {
          selected = opt.value;
          break;
        }
      }
      let finalDecision = "";
      if (selected === "default" || selected === "override") {
        const decisionHeader = document.querySelector(".bg-blue-100 h4").innerText;
        finalDecision = decisionHeader.split(":")[1].trim();
      } else if (selected === "review") {
        const comment = document.getElementById("reviewComment").value.trim();
        finalDecision = "Review - " + comment;
      }
      const results = {
        averageIncome: document.querySelector(".summary-table tr:nth-child(1) td").innerText,
        averageExpenses: document.querySelector(".summary-table tr:nth-child(2) td").innerText,
        averageGambling: document.querySelector(".summary-table tr:nth-child(3) td").innerText,
        averageDisposableIncome: document.querySelector(".summary-table tr:nth-child(4) td").innerText,
        gamblingPercentIncome: document.querySelector(".summary-table tr:nth-child(5) td").innerText,
        gamblingPercentDisposable: document.querySelector(".summary-table tr:nth-child(6) td").innerText,
        loanRepaymentPercent: document.querySelector(".summary-table tr:nth-child(7) td").innerText,
        decision: finalDecision
      };
      console.log("Final Submission Decision JSON:", results);
      alert("Decision submitted. Check console for JSON output.");
    }
    
    /*************************************
     * Render Timer Override Box
     *************************************/
    function renderTimerOverrideBox(timePerBank) {
      const container = document.getElementById("errorContainer");
      let timerDiv = document.getElementById("timerOverrideDiv");
      if (!timerDiv) {
        timerDiv = document.createElement("div");
        timerDiv.id = "timerOverrideDiv";
        timerDiv.classList.add("w-full", "mt-2", "p-4");
        container.appendChild(timerDiv);
      }
      let message, overrideText, bgColor;
      if (timePerBank < TIMER_CONFIG.minTime) {
        message = TIMER_CONFIG.warningMessageLow.replace("{time}", timePerBank.toFixed(1));
        overrideText = TIMER_CONFIG.overrideTextLow;
        bgColor = "bg-yellow-100 border-yellow-400 text-yellow-700";
      } else if (timePerBank > TIMER_CONFIG.maxTime) {
        message = TIMER_CONFIG.warningMessageHigh.replace("{time}", timePerBank.toFixed(1));
        overrideText = TIMER_CONFIG.overrideTextHigh;
        bgColor = "bg-yellow-100 border-yellow-400 text-yellow-700";
      } else {
        message = TIMER_CONFIG.normalMessage;
        overrideText = TIMER_CONFIG.overrideTextNormal;
        bgColor = "bg-green-100 border-green-400 text-green-700";
      }
      timerDiv.innerHTML = `
        <div class="border ${bgColor} px-4 py-3 rounded relative w-full" role="alert">
          <span>${message}</span>
          <div class="mt-2">
            <input type="checkbox" id="timerOverrideCheckbox" class="mr-2">
            <label for="timerOverrideCheckbox">${overrideText}</label>
          </div>
        </div>
      `;
      document.getElementById("timerOverrideCheckbox").addEventListener("change", (e) => {
        timerOverrideAcknowledged = e.target.checked;
        checkAllOverrides();
      });
    }
    
    /*************************************
     * Render Override Checkboxes for Bank Warnings
     *************************************/
    function renderOverrideCheckboxes() {
      overrides = new Array(statements.length).fill(false);
      statements.forEach((_, idx) => {
        const btnContainer = document.querySelectorAll("#bankStatements .btn-container")[idx];
        const btn = btnContainer.querySelector("button");
        btn.style.backgroundColor = "orange";
        btn.innerText = "Edit Data";
        const tickSpan = document.getElementById("tick_" + idx);
        tickSpan.innerText = "";
        let cb = document.getElementById("override_" + idx);
        if (!cb) {
          cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = "override_" + idx;
          cb.classList.add("ml-2");
          cb.addEventListener("change", () => {
            overrides[idx] = cb.checked;
            checkAllOverrides();
          });
          btnContainer.appendChild(cb);
          const label = document.createElement("label");
          label.setAttribute("for", "override_" + idx);
          label.classList.add("ml-1");
          label.innerText = "Submit despite warning";
          btnContainer.appendChild(label);
        }
      });
    }
    
    /*************************************
     * Check All Overrides
     *************************************/
    function checkAllOverrides() {
      const bankOverridesOk = (overrides.length === statements.length && overrides.every(val => val));
      const allOk = bankOverridesOk && timerOverrideAcknowledged;
      updateBankOverrideMessage();
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = !allOk;
      processBtn.style.backgroundColor = allOk ? "green" : "red";
    }
    
    function updateBankOverrideMessage() {
      const bankWarningsDiv = document.getElementById("bankWarningsDiv");
      if (bankWarningsDiv && (overrides.length === statements.length && overrides.every(val => val))) {
        if (!bankWarningsDiv.querySelector(".override-confirmation")) {
          const msg = document.createElement("div");
          msg.classList.add("override-confirmation", "mt-2", "font-bold", "text-red-700");
          msg.innerText = "User has elected to proceed despite these warnings";
          bankWarningsDiv.appendChild(msg);
        }
      }
    }
    
    /*************************************
     * Final Process Data Function
     *************************************/
    function processFinalData() {
      // Only run if all banks have been uploaded
      if (!statements.every(st => st.entered)) return;
      calculateAveragesAndDecision();
    }
    
    /*************************************
     * Session Check (updates login button)
     *************************************/
    function checkSession() {
      fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          const loginBtn = document.getElementById("loginBtn");
          const fetchDataBtn = document.getElementById("fetchDataBtn");
          if(data.logged_in) {
            loginBtn.innerText = "Logged in with Microsoft 365";
            loginBtn.className = "bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700";
            fetchDataBtn.disabled = false;
            fetchDataBtn.style.backgroundColor = "green";
          } else {
            loginBtn.innerText = "Log in with Microsoft 365";
            loginBtn.className = "bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700";
            fetchDataBtn.disabled = true;
            fetchDataBtn.style.backgroundColor = "red";
          }
        })
        .catch(err => { 
          console.error("Error checking session status:", err);
          const fetchDataBtn = document.getElementById("fetchDataBtn");
          fetchDataBtn.disabled = true;
          fetchDataBtn.style.backgroundColor = "red";
        });
    }
    
    /*************************************
     * On DOMContentLoaded
     *************************************/
    window.addEventListener("DOMContentLoaded", () => {
      forceLogout();
      checkSession();
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
      // Create the modal overlay for fetch errors
      const overlay = document.createElement("div");
      overlay.id = "modalOverlay";
      document.body.appendChild(overlay);
      const modal = document.createElement("div");
      modal.id = "fetchErrorModal";
      document.body.appendChild(modal);
    });
    
    // Listen for review comment input changes
    document.addEventListener("input", (e) => {
      if(e.target && e.target.id === "reviewComment") {
        checkReviewComment();
      }
    });
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg">
    <!-- Top bar with two buttons -->
    <div class="flex justify-between items-center mb-4">
      <button id="returnMenuBtn" onclick="window.location.href='https://affordability-review-main-menu.up.railway.app/'" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
        Return to Main Menu
      </button>
      <button id="loginBtn" onclick="window.location.href='https://web-production-15e92.up.railway.app/login'" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
        Log in with Microsoft 365
      </button>
    </div>
    
    <!-- Logo and Title -->
    <div class="text-center mb-4">
      <img src="https://github.com/craigmalenga/Image_belmond_Frontend/blob/main/Belmond%20logo.png?raw=true" alt="Company Logo" class="h-16 mx-auto mb-2"/>
      <h1 class="text-2xl font-bold">Affordability Assessment</h1>
    </div>
    
    <!-- Lead ID Section -->
    <label class="block font-medium">Enter Lead ID:</label>
    <div class="flex gap-2 mt-2">
      <input id="leadId" class="border p-2 flex-1 rounded-md text-gray-600" placeholder="123456789"/>
      <button id="fetchDataBtn" onclick="fetchLeadData()" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-blue-700" disabled>
        Fetch Data
      </button>
    </div>
    
    <!-- Timer Display -->
    <div id="timerDisplay" class="mt-4 font-semibold">Timer: 0:00:00</div>
    
    <!-- Lead Details -->
    <h2 class="text-lg font-semibold mt-6">Lead Details</h2>
    <input id="fullName" class="border p-2 w-full rounded-md bg-gray-200" readonly />
    <textarea id="bankNames" class="border p-2 w-full rounded-md bg-gray-200 mt-2" rows="3" readonly></textarea>
    <input id="periodCovered" class="border p-2 w-full rounded-md bg-gray-200 mt-2" readonly />
    <textarea id="statement_urls" class="border p-2 w-full rounded-md bg-gray-200 mt-2" rows="3" readonly></textarea>
    <input id="monthlyRepayment" class="border p-2 w-full rounded-md bg-gray-200 mt-2" type="number" readonly />
    
    <!-- Bank Statements Section -->
    <h2 class="text-lg font-semibold mt-6">Bank Statements</h2>
    <div id="bankStatements" class="mt-2"></div>
    <div id="statementForm"></div>
    
    <!-- Error / Warning Container -->
    <div id="errorContainer" class="w-full"></div>
    
    <!-- Process Data Button (remains until summary is generated) -->
    <button id="processDataBtn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md w-full" disabled onclick="processFinalData()">
      Process Data
    </button>
  </div>
</body>
</html>



