<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affordability Assessment</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    /*************************************
     * Function to Format Numbers with Commas
     *************************************/
    function formatNumber(value) {
      if (isNaN(value) || value === "" || value === null) return "";
      return Number(value).toLocaleString("en-GB", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    /*************************************
     * Function to Parse Input Before Storing
     *************************************/
    function parseInput(value) {
      if (!value) return 0.00;
      return parseFloat(value.replace(/,/g, ""));
    }

    /*************************************
     * Function to Apply Formatting on User Input
     *************************************/
    function applyFormatting(event) {
      let inputElem = event.target;
      let rawValue = inputElem.value;
      let formattedValue = formatNumber(parseInput(rawValue));
      inputElem.value = formattedValue;
    }

    /*************************************
     * Function to Load Data from FLG
     *************************************/
    function fetchLeadData() {
      const leadId = document.getElementById("leadId").value.trim();
      if (!leadId) { alert("Please enter a valid Lead ID."); return; }

      fetch(`https://web-production-15e92.up.railway.app/api/flg_data/${leadId}`, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          if (data.error) { alert(data.error); return; }

          document.getElementById("fullName").value = data.fullName || "";
          document.getElementById("periodCovered").value = data.periodCovered || "";

          let tableFields = ["Income", "Rent/Mortgage", "Council Tax", "Utilities", "Credit Commitments", "Gambling Expenditure"];
          let months = ["Mar-2025", "Apr-2025", "May-2025"];

          tableFields.forEach((category, rowIndex) => {
            months.forEach((_, monthIndex) => {
              let cellId = `${rowIndex}_${monthIndex}`;
              let fieldValue = parseInput(data[`data6_${cellId}`] || "0.00");  // Pull value, default to 0.00 if missing
              document.getElementById(cellId).value = formatNumber(fieldValue); // Display formatted number
            });
          });
        })
        .catch(err => {
          console.error("Error fetching FLG data:", err);
          alert("Unable to retrieve data - check Lead ID being entered and if issue persists, speak to a line manager.");
        });
    }
  </script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg">
    
    <h1 class="text-2xl font-bold text-center">Affordability Assessment</h1>

    <label for="leadId" class="block mt-4 font-medium">Enter Lead ID:</label>
    <div class="flex gap-2 mt-2">
      <input type="text" id="leadId" class="border p-2 flex-1 rounded-md text-gray-600"/>
      <button onclick="fetchLeadData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
        Fetch Data
      </button>
    </div>

    <h2 class="text-lg font-semibold mt-6">Lead Details</h2>
    <label class="block mt-2">Full Name:</label>
    <input type="text" id="fullName" class="border p-2 w-full rounded-md bg-gray-200" readonly />

    <label class="block mt-2">Period Covered:</label>
    <input type="text" id="periodCovered" class="border p-2 w-full rounded-md bg-gray-200" readonly />

    <!-- Table for Data Entry -->
    <h2 class="text-lg font-semibold mt-6">Bank Statement Data</h2>
    <table class="w-full border-collapse border border-gray-300 mt-4">
      <tr>
        <th class="border p-2">Category</th>
        <th class="border p-2">Mar-2025</th>
        <th class="border p-2">Apr-2025</th>
        <th class="border p-2">May-2025</th>
      </tr>

      <!-- Rows for Income, Rent, Utilities, etc. -->
      <tr>
        <td class="border p-2 font-semibold">Income</td>
        <td class="border p-2"><input type="text" id="0_0" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="0_1" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="0_2" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
      </tr>
      <tr>
        <td class="border p-2 font-semibold">Rent/Mortgage</td>
        <td class="border p-2"><input type="text" id="1_0" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="1_1" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="1_2" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
      </tr>
      <tr>
        <td class="border p-2 font-semibold">Council Tax</td>
        <td class="border p-2"><input type="text" id="2_0" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="2_1" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
        <td class="border p-2"><input type="text" id="2_2" class="border p-2 w-full text-right" onblur="applyFormatting(event)"></td>
      </tr>
    </table>

    <!-- Submit Button -->
    <button class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 w-full">
      Process Data
    </button>

  </div>
</body>
</html>
