<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affordability Assessment</title>
  <!-- Favicon snippets -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas and jsPDF libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url("https://github.com/craigmalenga/affordability-frontend/blob/main/Background.png?raw=true") no-repeat center center fixed;
      background-size: cover;
    }
    #errorContainer, #bankWarningsDiv, #timerOverrideDiv {
      width: 100%;
    }
    #errorContainer { margin-bottom: 20px; }
    .warning-box, .time-box, .decision-box {
      width: 100%;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .warning-box h3, .time-box h3, .decision-box h3 {
      font-size: 1.125rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .warning-box { border: 1px solid #f87171; background-color: #fef2f2; color: #b91c1c; }
    .time-box { border: 1px solid #facc15; background-color: #fefce8; color: #b45309; }
    .decision-box { border: 1px solid #3b82f6; background-color: #dbeafe; color: #1e3a8a; }
    #alertOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
    }
    #alertBox {
      display: none;
      position: fixed;
      width: 300px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #aaa;
      border-radius: 8px;
      padding: 20px;
      z-index: 1000;
    }
    #alertMessage { margin-bottom: 1rem; }
    #alertButton {
      background: #3490dc;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #alertButton:hover { background: #2779bd; }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .summary-table th, .summary-table td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .summary-table th { background-color: #f9f9f9; text-align: left; }
    #debugOutput {
      margin-top: 1rem;
      padding: 8px;
      background-color: #fff;
      border: 1px solid #a0aec0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
  <script>
    /*************************************
     * Debug Logging Utility
     *************************************/
    function debugLog(msg) {
      console.debug(msg);
      const debugOutput = document.getElementById("debugOutput");
      if (debugOutput) { debugOutput.innerText += msg + "\n"; }
    }
    /*************************************
     * Screenshot PDF & Secure S3 Upload Functions
     *************************************/
    function captureScreenshotPDF() {
      debugLog("DEBUG: Starting screenshot capture using html2canvas.");
      return html2canvas(document.body).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        debugLog("DEBUG: Screenshot captured, converting to PDF.");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        debugLog("DEBUG: PDF generated successfully.");
        return pdf.output('blob');
      });
    }
    function generateFilename(leadId) {
      const randomNum = Math.floor(100000000 + Math.random() * 900000000);
      const now = new Date();
      const day = now.getDate().toString().padStart(2, '0');
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const month = monthNames[now.getMonth()];
      const year = now.getFullYear().toString().substr(-2);
      const filename = `affordability_decision_screenshot-${leadId}-${randomNum}-${day}${month}${year}.pdf`;
      debugLog("DEBUG: Generated filename: " + filename);
      return filename;
    }
    // New secure upload: Get a presigned URL from backend and then PUT the PDF blob
    function uploadScreenshotSecure(pdfBlob, filename) {
      return fetch(`https://web-production-15e92.up.railway.app/api/generate_presigned_url?filename=${encodeURIComponent(filename)}`, { credentials: "include" })
      .then(resp => resp.json())
      .then(data => {
        if(data.error) {
          throw new Error(data.error);
        }
        const presignedUrl = data.presigned_url;
        const publicUrl = data.public_url;
        debugLog("DEBUG: Obtained presigned URL: " + presignedUrl);
        return fetch(presignedUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/pdf" },
          body: pdfBlob
        }).then(uploadResp => {
          if (uploadResp.ok) {
            debugLog("DEBUG: S3 upload succeeded.");
            return publicUrl;
          } else {
            debugLog("DEBUG: S3 upload failed with status " + uploadResp.status);
            throw new Error("S3 Upload failed");
          }
        });
      });
    }
    /*************************************
     * Timer Configuration and Global Variables
     *************************************/
    let TIMER_CONFIG = {};
    fetch('./timer_config.json')
      .then(resp => resp.json())
      .then(cfg => { TIMER_CONFIG = cfg; })
      .catch(err => { console.error("Failed to load timer_config.json:", err); showAlert("Critical error: Timer configuration file could not be loaded."); });
    const categories = ["Income", "Rent/Mortgage", "Council Tax", "Utilities", "Credit Commitments", "Gambling Expenditure"];
    let dynamicMonths = [];
    let statements = [];
    let priorInputData = "";
    let overrides = [];
    let timerOverrideAcknowledged = false;
    let startTime = null;
    let timerInterval = null;
    let totalTimeSpentSeconds = 0;
    let finalProcessingInitiated = false;
    let finalDecision = "";
    /*************************************
     * Centered Alert Functions
     *************************************/
    function showAlert(msg) {
      document.getElementById("alertMessage").innerText = msg;
      document.getElementById("alertOverlay").style.display = "block";
      document.getElementById("alertBox").style.display = "block";
    }
    function closeAlert() {
      document.getElementById("alertOverlay").style.display = "none";
      document.getElementById("alertBox").style.display = "none";
    }
    /*************************************
     * Timer Functions
     *************************************/
    function updateTimerDisplay() {
      if (!startTime) return;
      const diffSec = Math.floor((new Date() - startTime) / 1000);
      const hh = Math.floor(diffSec / 3600).toString().padStart(1, '0');
      const mm = Math.floor((diffSec % 3600) / 60).toString().padStart(2, '0');
      const ss = (diffSec % 60).toString().padStart(2, '0');
      document.getElementById("timerDisplay").innerText = `Timer: ${hh}:${mm}:${ss}`;
    }
    function startTimer() {
      startTime = new Date();
      updateTimerDisplay();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      totalTimeSpentSeconds = Math.floor((new Date() - startTime) / 1000);
      return totalTimeSpentSeconds;
    }
    /*************************************
     * Numeric Formatting
     *************************************/
    function formatNumericValue(num) {
      return num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    /*************************************
     * Save Data
     *************************************/
    function saveData(statementIndex, rowIndex, monthIndex) {
      const inputId = `${statementIndex}_${rowIndex}_${monthIndex}`;
      const inputElem = document.getElementById(inputId);
      let val = parseFloat(inputElem.value.replace(/,/g, ''));
      if (isNaN(val)) val = 0;
      statements[statementIndex].data[`${rowIndex}_${monthIndex}`] = val;
      inputElem.value = formatNumericValue(val);
      const cb = document.getElementById("override_" + statementIndex);
      if (cb && cb.checked) {
        cb.checked = false;
        overrides[statementIndex] = false;
        checkAllOverrides();
      }
    }
    /*************************************
     * Reset Form
     *************************************/
    function resetForm() {
      document.getElementById("fullName").value = "";
      document.getElementById("bankNames").value = "";
      document.getElementById("statement_urls").value = "";
      document.getElementById("periodCovered").value = "";
      document.getElementById("monthlyRepayment").value = "";
      document.getElementById("statementForm").innerHTML = "";
      document.getElementById("bankStatements").innerHTML = "";
      document.getElementById("errorContainer").innerHTML = "";
      statements = [];
      overrides = [];
      priorInputData = "";
      timerOverrideAcknowledged = false;
      finalProcessingInitiated = false;
      if (timerInterval) clearInterval(timerInterval);
      startTime = null;
      totalTimeSpentSeconds = 0;
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = true;
      processBtn.style.backgroundColor = "red";
      processBtn.innerText = "Process Data";
    }
    /*************************************
     * Fetch Lead Data
     *************************************/
    function fetchLeadData() {
      resetForm();
      const leadId = document.getElementById("leadId").value.trim();
      if (!leadId) {
        showAlert("Please enter a valid Lead ID.");
        return;
      }
      startTimer();
      fetch(`https://web-production-15e92.up.railway.app/api/flg_data/${leadId}`, { credentials: 'include' })
        .then(resp => resp.json())
        .then(data => {
          if (data.error) {
            showAlert("Unable to retrieve data – check Lead ID being entered and if issue persists, speak to a line manager");
            return;
          }
          document.getElementById("fullName").value = data.fullName || "";
          if (data.bankNames) {
            const bankNamesLines = data.bankNames.split(",").map(n => n.trim()).join("\n");
            document.getElementById("bankNames").value = bankNamesLines;
          }
          if (data.statement_urls) {
            const urlsLines = data.statement_urls.split(",").map(u => u.trim()).join("\n");
            document.getElementById("statement_urls").value = urlsLines;
          }
          document.getElementById("periodCovered").value = data.periodCovered || "";
          document.getElementById("monthlyRepayment").value = data.monthlyRepayment || "";
          if (Array.isArray(data.monthsForTable) && data.monthsForTable.length === 3) {
            dynamicMonths = data.monthsForTable;
          } else {
            dynamicMonths = ["N/A", "N/A", "N/A"];
          }
          if (data.bankNames && data.statement_urls) {
            const bankNamesArr = data.bankNames.split(",").map(n => n.trim()).filter(Boolean);
            const statementUrlsArr = data.statement_urls.split(",").map(u => u.trim()).filter(Boolean);
            if (bankNamesArr.length !== statementUrlsArr.length) {
              showAlert("Mismatch between number of bank names and statement URLs.");
              return;
            }
            statements = bankNamesArr.map((bank, index) => ({
              bank: bank,
              file: statementUrlsArr[index],
              entered: false,
              prepopulated: false,
              data: {}
            }));
            createStatementLinks();
          }
          if (data.inputData && data.inputData.trim() !== "") {
            priorInputData = data.inputData.trim();
            createLoadPriorButton();
          }
        })
        .catch(err => {
          console.error("Error fetching FLG data:", err);
          showAlert("Unable to retrieve data – check Lead ID being entered and if issue persists, speak to a line manager");
        });
    }
    /*************************************
     * Create Statement Links
     *************************************/
    function createStatementLinks() {
      const pdfContainer = document.getElementById("bankStatements");
      pdfContainer.innerHTML = "";
      statements.forEach((statement, index) => {
        const container = document.createElement("div");
        container.classList.add("mb-4");
        const viewLink = document.createElement("a");
        viewLink.href = statement.file;
        viewLink.innerText = `View ${statement.bank} statement`;
        viewLink.classList.add("text-blue-500", "underline", "cursor-pointer");
        viewLink.onclick = (e) => { e.preventDefault(); window.open(statement.file, "_blank"); };
        const btnContainer = document.createElement("div");
        btnContainer.classList.add("btn-container", "ml-4", "mt-2", "flex", "items-center");
        const enterDataBtn = document.createElement("button");
        enterDataBtn.id = "enterDataBtn_" + index;
        enterDataBtn.innerText = "Enter Data";
        enterDataBtn.classList.add("bg-blue-600", "text-white", "px-4", "py-2", "rounded-md");
        enterDataBtn.onclick = () => loadStatementForm(index);
        const tickSpan = document.createElement("span");
        tickSpan.id = "tick_" + index;
        tickSpan.classList.add("ml-2", "font-bold");
        tickSpan.innerText = "";
        btnContainer.appendChild(enterDataBtn);
        btnContainer.appendChild(tickSpan);
        container.appendChild(viewLink);
        container.appendChild(btnContainer);
        pdfContainer.appendChild(container);
      });
    }
    /*************************************
     * Create Load Prior Input Button
     *************************************/
    function createLoadPriorButton() {
      if (document.getElementById("loadPriorBtn")) return;
      const bankStatementsDiv = document.getElementById("bankStatements");
      const loadPriorBtnContainer = document.createElement("div");
      loadPriorBtnContainer.classList.add("mb-4");
      const loadPriorBtn = document.createElement("button");
      loadPriorBtn.id = "loadPriorBtn";
      loadPriorBtn.innerText = "Option: load prior input data statement categorisation";
      loadPriorBtn.classList.add("bg-green-600", "text-white", "px-4", "py-2", "rounded-md", "block", "text-center", "w-full");
      loadPriorBtn.onclick = loadPriorInputData;
      loadPriorBtnContainer.appendChild(loadPriorBtn);
      bankStatementsDiv.appendChild(loadPriorBtnContainer);
    }
    /*************************************
     * Load Statement Form
     *************************************/
    function loadStatementForm(statementIndex) {
      const statement = statements[statementIndex];
      const formContainer = document.getElementById("statementForm");
      formContainer.innerHTML = `<h3 class='text-lg font-bold mt-6'>${statement.bank} Statement Data</h3>`;
      const months = (dynamicMonths.length === 3) ? dynamicMonths : ["Month1", "Month2", "Month3"];
      let table = `<table class='w-full border-collapse border border-gray-300 mt-4'><tr><th class='border p-2'>Category</th>`;
      months.forEach(month => { table += `<th class='border p-2'>${month}</th>`; });
      table += "</tr>";
      categories.forEach((category, rowIndex) => {
        table += `<tr><td class='border p-2 font-semibold'>${category}</td>`;
        months.forEach((_, monthIndex) => {
          const rawVal = statement.data[`${rowIndex}_${monthIndex}`] || 0;
          const displayVal = formatNumericValue(rawVal);
          table += `<td class='border p-2'>
              <input type='text' id='${statementIndex}_${rowIndex}_${monthIndex}'
                     class='border p-2 w-full rounded-md text-right'
                     value="${displayVal}"
                     onblur="saveData(${statementIndex}, ${rowIndex}, ${monthIndex})">
            </td>`;
        });
        table += "</tr>";
      });
      table += "</table>";
      table += `<button onclick='uploadBankData(${statementIndex})'
                class='mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 w-full'>
          Upload data for this bank to summary before processing
        </button>`;
      formContainer.innerHTML = table;
    }
    function uploadBankData(statementIndex) {
      statements[statementIndex].entered = true;
      const btnContainer = document.querySelectorAll("#bankStatements .btn-container")[statementIndex];
      const enterDataBtn = btnContainer.querySelector("button");
      enterDataBtn.innerText = "Edit Data";
      enterDataBtn.style.backgroundColor = "green";
      const tickSpan = document.getElementById("tick_" + statementIndex);
      tickSpan.innerText = "✔";
      tickSpan.style.color = "green";
      const existingOverride = document.getElementById("override_" + statementIndex);
      if (existingOverride) {
        const label = existingOverride.nextElementSibling;
        existingOverride.remove();
        if (label) label.remove();
      }
      checkProcessButton();
    }
    /*************************************
     * Load Prior Input Data
     *************************************/
    function loadPriorInputData() {
      if (!priorInputData) {
        showAlert("No prior input data available.");
        return;
      }
      const loadPriorBtn = document.getElementById("loadPriorBtn");
      if (!loadPriorBtn.disabled) {
        const fields = priorInputData.split(",").map(f => f.trim());
        const groupSize = 19;
        for (let i = 0; i < fields.length; i += groupSize) {
          const group = fields.slice(i, i + groupSize);
          if (group.length < groupSize) continue;
          const bankNameFromData = group[0];
          const foundIndex = statements.findIndex(s => s.bank.toLowerCase() === bankNameFromData.toLowerCase());
          if (foundIndex !== -1) {
            statements[foundIndex].prepopulated = true;
            for (let row = 0; row < categories.length; row++) {
              for (let month = 0; month < 3; month++) {
                const fieldIndex = 1 + (row * 3) + month;
                let val = parseFloat(group[fieldIndex].replace(/,/g, ''));
                if (isNaN(val)) val = 0;
                statements[foundIndex].data[`${row}_${month}`] = val;
                const inputElem = document.getElementById(`${foundIndex}_${row}_${month}`);
                if (inputElem) {
                  inputElem.value = val.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
            const btn = document.getElementById(`enterDataBtn_${foundIndex}`);
            if (btn) {
              btn.innerText = "Review Data";
              btn.classList.remove("bg-blue-600", "text-white");
              btn.classList.add("bg-yellow-400", "text-white");
            }
          }
        }
        loadPriorBtn.innerText = "Data has been loaded. If you want to reload, please Fetch Data again for this Lead ID";
        loadPriorBtn.disabled = true;
        loadPriorBtn.classList.remove("bg-green-600");
        loadPriorBtn.classList.add("bg-blue-600");
        showAlert("Prior input data loaded for matching bank accounts.");
      }
    }
    /*************************************
     * Check Process Button
     *************************************/
    function checkProcessButton() {
      const allEntered = statements.every(st => st.entered);
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = !allEntered;
      processBtn.style.backgroundColor = allEntered ? "green" : "red";
      const finalSubmitBtn = document.getElementById("finalSubmitBtn");
      if (finalSubmitBtn) {
        const decisionOptions = document.getElementsByName("decisionOption");
        let selected = "";
        for (let opt of decisionOptions) {
          if (opt.checked) { selected = opt.value; break; }
        }
        const reviewComment = document.getElementById("reviewComment");
        const commentVal = reviewComment ? reviewComment.value.trim() : "";
        if (!allEntered || selected === "" || (selected === "review" && !commentVal)) {
          finalSubmitBtn.disabled = true;
        } else {
          finalSubmitBtn.disabled = false;
        }
      }
    }
    /*************************************
     * Override Check Functions
     *************************************/
    function checkAllOverrides() {
      const bankOverridesOk = (overrides.length === statements.length && overrides.every(val => val));
      const allOk = bankOverridesOk && timerOverrideAcknowledged;
      updateBankOverrideMessage();
      const processBtn = document.getElementById("processDataBtn");
      processBtn.disabled = !allOk;
      processBtn.style.backgroundColor = allOk ? "green" : "red";
      const finalSubmitBtn = document.getElementById("finalSubmitBtn");
      if (finalSubmitBtn) {
        const decisionOptions = document.getElementsByName("decisionOption");
        let selected = "";
        for (let opt of decisionOptions) {
          if (opt.checked) { selected = opt.value; break; }
        }
        const reviewComment = document.getElementById("reviewComment");
        const commentVal = reviewComment ? reviewComment.value.trim() : "";
        if (!allOk || selected === "" || (selected === "review" && !commentVal)) {
          finalSubmitBtn.disabled = true;
        } else {
          finalSubmitBtn.disabled = false;
        }
      }
    }
    function renderOverrideCheckboxes() {
      overrides = new Array(statements.length).fill(false);
      statements.forEach((_, idx) => {
        const btnContainer = document.querySelectorAll("#bankStatements .btn-container")[idx];
        const btn = btnContainer.querySelector("button");
        btn.style.backgroundColor = "orange";
        btn.innerText = "Edit Data";
        const tickSpan = document.getElementById("tick_" + idx);
        tickSpan.innerText = "";
        let cb = document.getElementById("override_" + idx);
        if (!cb) {
          cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = "override_" + idx;
          cb.classList.add("ml-2");
          cb.addEventListener("change", () => { overrides[idx] = cb.checked; checkAllOverrides(); });
          btnContainer.appendChild(cb);
          const label = document.createElement("label");
          label.setAttribute("for", "override_" + idx);
          label.classList.add("ml-1");
          label.innerText = "Submit despite warning";
          btnContainer.appendChild(label);
        }
      });
    }
    function updateBankOverrideMessage() {
      const bankWarningsDiv = document.getElementById("bankWarningsDiv");
      if (bankWarningsDiv && (overrides.length === statements.length && overrides.every(val => val))) {
        if (!bankWarningsDiv.querySelector(".override-confirmation")) {
          const msg = document.createElement("div");
          msg.classList.add("override-confirmation", "mt-2", "font-bold", "text-red-700");
          msg.innerText = "User has elected to proceed despite these warnings";
          bankWarningsDiv.appendChild(msg);
        }
      }
    }
    /*************************************
     * Render Timer Override Box
     *************************************/
    function renderTimerOverrideBox(timePerBank) {
      const container = document.getElementById("errorContainer");
      let timerDiv = document.getElementById("timerOverrideDiv");
      if (!timerDiv) {
        timerDiv = document.createElement("div");
        timerDiv.id = "timerOverrideDiv";
        timerDiv.classList.add("time-box");
        container.appendChild(timerDiv);
      }
      const minTime = TIMER_CONFIG.base_lower_limit || 15;
      const maxTime = TIMER_CONFIG.base_upper_limit || 30;
      const warningLow = TIMER_CONFIG.warning_message_low || "Time too low: {time}";
      const warningHigh = TIMER_CONFIG.warning_message_high || "Time too high: {time}";
      const normalMsg = TIMER_CONFIG.normal_message || "Time is normal";
      const overrideLow = TIMER_CONFIG.override_text_low || "Submit despite warning";
      const overrideHigh = TIMER_CONFIG.override_text_high || "Submit despite warning";
      const overrideNormal = TIMER_CONFIG.override_text_normal || "Acknowledge timing achieved";
      let message, overrideText;
      if (timePerBank < minTime) {
        message = warningLow.replace("{time}", timePerBank.toFixed(1));
        overrideText = overrideLow;
      } else if (timePerBank > maxTime) {
        message = warningHigh.replace("{time}", timePerBank.toFixed(1)).replace("{min}", minTime).replace("{max}", maxTime);
        overrideText = overrideHigh;
      } else {
        message = normalMsg.replace("{min}", minTime).replace("{max}", maxTime);
        overrideText = overrideNormal;
      }
      timerDiv.innerHTML = `
        <h3>Information on time you've taken to process this data:</h3>
        <p>${message}</p>
        <div class="mt-2">
          <input type="checkbox" id="timerOverrideCheckbox" class="mr-2" />
          <label for="timerOverrideCheckbox">${overrideText}</label>
        </div>
      `;
      document.getElementById("timerOverrideCheckbox").addEventListener("change", (e) => { timerOverrideAcknowledged = e.target.checked; checkAllOverrides(); });
    }
    /*************************************
     * Process Data (Final Summary)
     *************************************/
    function processFinalData() {
      if (!statements.every(st => st.entered)) return;
      if (!finalProcessingInitiated && document.getElementById("bankWarningsDiv") && document.getElementById("bankWarningsDiv").innerHTML !== "") {
        finalProcessingInitiated = true;
        const processBtn = document.getElementById("processDataBtn");
        processBtn.innerText = "Confirm and Show Final Decision";
        processBtn.style.backgroundColor = "blue";
        return;
      }
      document.getElementById("errorContainer").innerHTML = "";
      document.getElementById("statementForm").innerHTML = "";
      showSummaryAndDecision();
      document.getElementById("processDataBtn").style.display = "none";
    }
    function showSummaryAndDecision() {
      const nBanks = statements.length;
      const nMonths = dynamicMonths.length;
      let totalIncome = 0, totalExpenses = 0, totalGambling = 0;
      statements.forEach(st => {
        for (let m = 0; m < nMonths; m++) {
          totalIncome += (st.data[`0_${m}`] || 0);
          let exp = 0;
          for (let r = 1; r <= 4; r++) { exp += (st.data[`${r}_${m}`] || 0); }
          totalExpenses += exp;
          totalGambling += (st.data[`5_${m}`] || 0);
        }
      });
      const avgIncome = totalIncome / (nBanks * nMonths);
      const avgExpenses = totalExpenses / (nBanks * nMonths);
      const avgGambling = totalGambling / (nBanks * nMonths);
      let avgDisposable = avgIncome - avgExpenses + avgGambling;
      const safeDisposable = (avgDisposable > 0) ? avgDisposable : 0;
      const safeIncome = (avgIncome > 0) ? avgIncome : 0;
      const gambPctIncome = safeIncome > 0 ? (avgGambling / safeIncome) * 100 : 0;
      const gambPctDisposable = safeDisposable > 0 ? (avgGambling / safeDisposable) * 100 : 0;
      const monthlyRepayment = parseFloat(document.getElementById("monthlyRepayment").value) || 0;
      const loanRepayPct = safeDisposable > 0 ? (monthlyRepayment / safeDisposable) * 100 : 0;
      let bankWarnings = "";
      let sumIncomeArr = Array(nMonths).fill(0);
      let sumExpensesArr = Array(nMonths).fill(0);
      statements.forEach(st => {
        for (let m = 0; m < nMonths; m++) {
          sumIncomeArr[m] += (st.data[`0_${m}`] || 0);
          let e = 0;
          for (let r = 1; r <= 4; r++) { e += (st.data[`${r}_${m}`] || 0); }
          sumExpensesArr[m] += e;
        }
      });
      let problemMonths = [];
      for (let i = 0; i < nMonths; i++) {
        if (sumExpensesArr[i] > sumIncomeArr[i]) { problemMonths.push(dynamicMonths[i]); }
        if (sumIncomeArr[i] === 0 && sumExpensesArr[i] === 0) {
          bankWarnings += `No income or expenses entered for month ${dynamicMonths[i]} (possibly incomplete data).<br/>`;
        } else if (sumIncomeArr[i] === 0) {
          bankWarnings += `No income entered for month ${dynamicMonths[i]} (possibly incomplete data).<br/>`;
        } else if (sumExpensesArr[i] === 0) {
          bankWarnings += `No expenses entered for month ${dynamicMonths[i]} (possibly incomplete data).<br/>`;
        }
      }
      if (problemMonths.length === 1) {
        bankWarnings += `Expenses exceed income for month ${problemMonths[0]}.<br/>`;
      } else if (problemMonths.length === 2) {
        bankWarnings += `Expenses exceed income for months ${problemMonths[0]} and ${problemMonths[1]}.<br/>`;
      } else if (problemMonths.length > 2) {
        bankWarnings += `Expenses exceed income for months ${problemMonths.join(", ")}.<br/>`;
      }
      const totalSec = Math.floor((new Date() - startTime) / 1000);
      let nBanksManual = statements.filter(st => !st.prepopulated).length;
      if (nBanksManual < 1) nBanksManual = 1;
      const timePerBank = (totalSec / 60) / nBanksManual;
      let warningsHTML = "";
      if (bankWarnings) {
        warningsHTML = `<div id="bankWarningsDiv" class="warning-box">
            <h3>Please review your entries:</h3>
            <p>${bankWarnings}</p>
          </div>`;
        renderOverrideCheckboxes();
      }
      let timeHTML = `<div id="timerOverrideDiv" class="time-box">
          <h3>Information on time you've taken to process this data:</h3>
          <p></p>
          <div class="mt-2">
            <input type="checkbox" id="timerOverrideCheckbox" class="mr-2" />
            <label for="timerOverrideCheckbox">[Will be filled dynamically]</label>
          </div>
        </div>`;
      document.getElementById("errorContainer").innerHTML = warningsHTML + timeHTML;
      renderTimerOverrideBox(timePerBank);
      let decision = "";
      let reason = "";
      if (gambPctIncome > 15) { decision = "Unaffordable"; reason = "Gambling exceeds 15% of income, indicating financial risk."; }
      else if (gambPctIncome >= 10 && gambPctIncome <= 14 && loanRepayPct > 50) { decision = "Unaffordable"; reason = "Gambling between 10–14% and repayment exceeds 50% of disposable income."; }
      else if (gambPctIncome < 10 && loanRepayPct > 65) { decision = "Unaffordable"; reason = "Gambling is below 10%, but repayment cost is over 65% of disposable income."; }
      else { decision = "Affordability"; reason = "Neither gambling nor repayment costs indicate financial distress."; }
      let decisionHTML = `<div class="decision-box mt-4">
          <h3>Decision: ${decision}</h3>
          <p>${reason}</p>
        </div>`;
      const dispAvgIncome = `£${formatNumericValue(avgIncome)}`;
      const dispAvgExpenses = `£${formatNumericValue(avgExpenses)}`;
      const dispAvgGambling = `£${formatNumericValue(avgGambling)}`;
      const dispAvgDisposable = `£${formatNumericValue(avgDisposable)}`;
      const dispGambPctIncome = `${Math.round(gambPctIncome)}%`;
      const dispGambPctDisposable = `${Math.round(gambPctDisposable)}%`;
      const dispLoanRepayPct = `${Math.round(loanRepayPct)}%`;
      let summaryHTML = `<table class="summary-table">
          <tr><th>Average Income</th><td style="text-align:right;">${dispAvgIncome} per month</td></tr>
          <tr><th>Average Expenses (excl. gambling)</th><td style="text-align:right;">${dispAvgExpenses} per month</td></tr>
          <tr><th>Average Gambling</th><td style="text-align:right;">${dispAvgGambling} per month</td></tr>
          <tr><th>Average Disposable Income</th><td style="text-align:right;">${dispAvgDisposable} per month</td></tr>
          <tr><th>Gambling as % of Income</th><td style="text-align:right;">${dispGambPctIncome}</td></tr>
          <tr><th>Gambling as % of Disposable Income</th><td style="text-align:right;">${dispGambPctDisposable}</td></tr>
          <tr><th>Loan Repayments as % of Disposable Income</th><td style="text-align:right;">${dispLoanRepayPct}</td></tr>
        </table>`;
      let processDecisionHTML = `<div class="bg-gray-50 p-4 mt-4 border rounded">
          <h4 class="font-bold mb-2">Process Decision</h4>
          <div class="mb-2">
            <label class="inline-flex items-center">
              <input type="radio" name="decisionOption" value="default" onchange="checkDecisionOptions()" class="form-radio h-5 w-5 text-green-600">
              <span class="ml-2">Submit in line with decision above</span>
            </label>
          </div>
          <div class="mb-2">
            <label class="inline-flex items-center">
              <input type="radio" name="decisionOption" value="review" onchange="checkDecisionOptions()" class="form-radio h-5 w-5 text-green-600">
              <span class="ml-2">More information required</span>
            </label>
          </div>
          <div id="reviewCommentContainer" class="mt-2" style="display:none;">
            <label class="block mb-1 font-medium">Please enter reason for review:</label>
            <input type="text" id="reviewComment" class="border p-2 w-full rounded-md" placeholder="Enter reason here" oninput="checkDecisionOptions()">
          </div>
          <button id="finalSubmitBtn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md w-full" disabled onclick="finalSubmitDecision()">
            Submit Decision
          </button>
        </div>`;
      const formDiv = document.getElementById("statementForm");
      formDiv.innerHTML = `<div class="bg-white p-4 mt-6 shadow-md">
          <h3 class="text-xl font-bold mb-4">Calculated Averages and Analysis</h3>
          ${summaryHTML}
        </div>
        ${decisionHTML}
        ${processDecisionHTML}`;
    }
    /*************************************
     * Decision Option Checks
     *************************************/
    function checkDecisionOptions() {
      const decisionOptions = document.getElementsByName("decisionOption");
      let selected = "";
      for (let opt of decisionOptions) {
        if (opt.checked) { selected = opt.value; break; }
      }
      const reviewContainer = document.getElementById("reviewCommentContainer");
      const finalSubmitBtn = document.getElementById("finalSubmitBtn");
      if (selected === "review") {
        reviewContainer.style.display = "block";
        let comment = document.getElementById("reviewComment").value.trim();
        comment = comment.replace(/,/g, "");
        finalSubmitBtn.disabled = !comment;
      } else {
        reviewContainer.style.display = "none";
        finalSubmitBtn.disabled = (selected === "");
      }
      checkAllOverrides();
    }
    /*************************************
     * Build data6 and data7
     *************************************/
    function buildAffordabilityInput() {
      let arr = [];
      statements.forEach(st => {
        arr.push(st.bank);
        for (let r = 0; r < categories.length; r++) {
          for (let m = 0; m < 3; m++) {
            let val = st.data[`${r}_${m}`] || 0;
            arr.push(val.toFixed(2));
          }
        }
      });
      return arr.join(",");
    }
    function buildAffordabilityOutput(avgInc, avgExp, avgGamb, avgDisp, pctInc, pctDisp, pctLoan, finalDecision, finalReason, timeMin) {
      const fmtNum = (val) => val.toFixed(2);
      const fmtPct = (val) => (val).toFixed(0) + "%";
      let items = [];
      items.push(fmtNum(avgInc));
      items.push(fmtNum(avgExp));
      items.push(fmtNum(avgGamb));
      items.push(fmtNum(avgDisp));
      items.push(fmtPct(pctInc));
      items.push(fmtPct(pctDisp));
      items.push(fmtPct(pctLoan));
      items.push(finalDecision);
      items.push(finalReason);
      items.push(Math.round(timeMin));
      return items.join(",");
    }
    /*************************************
     * Final Submit Decision with Secure S3 Upload
     *************************************/
     function finalSubmitDecision() {
        const decisionOptions = document.getElementsByName("decisionOption");
        let selected = "";
        for (let opt of decisionOptions) {
          if (opt.checked) { selected = opt.value; break; }
        }
        const decBox = document.querySelector(".decision-box h3");
        if (!decBox) {
          showAlert("No decision box found. Did you process data first?");
          return;
        }
        const autoDecision = decBox.innerText.split(":")[1].trim();
        const decParagraph = document.querySelector(".decision-box p");
        let autoReason = decParagraph ? decParagraph.innerText.trim() : "";
        let finalDecision = "";
        let finalReason = "";
        if (selected === "default") {
          finalDecision = autoDecision;
          finalReason = autoReason;
        } else if (selected === "review") {
          let comment = document.getElementById("reviewComment").value.trim();
          comment = comment.replace(/,/g, "");
          finalDecision = "Revisit - " + comment;
          finalReason = "";
        }
        
        const nBanks = statements.length;
        const nMonths = dynamicMonths.length;
        let totalIncome = 0, totalExpenses = 0, totalGambling = 0;
        statements.forEach(st => {
          for (let m = 0; m < nMonths; m++) {
            totalIncome += (st.data[`0_${m}`] || 0);
            let exp = 0;
            for (let r = 1; r <= 4; r++) { exp += (st.data[`${r}_${m}`] || 0); }
            totalExpenses += exp;
            totalGambling += (st.data[`5_${m}`] || 0);
          }
        });
        const avgIncome = (nBanks * nMonths > 0) ? (totalIncome / (nBanks * nMonths)) : 0;
        const avgExpenses = (nBanks * nMonths > 0) ? (totalExpenses / (nBanks * nMonths)) : 0;
        const avgGambling = (nBanks * nMonths > 0) ? (totalGambling / (nBanks * nMonths)) : 0;
        const avgDisposable = avgIncome - avgExpenses + avgGambling;
        const safeDisposable = (avgDisposable > 0) ? avgDisposable : 0;
        const safeIncome = (avgIncome > 0) ? avgIncome : 0;
        const monthlyRepayment = parseFloat(document.getElementById("monthlyRepayment").value) || 0;
        const gambPctIncome = safeIncome > 0 ? (avgGambling / safeIncome) * 100 : 0;
        const gambPctDisposable = safeDisposable > 0 ? (avgGambling / safeDisposable) * 100 : 0;
        const loanRepayPct = safeDisposable > 0 ? (monthlyRepayment / safeDisposable) * 100 : 0;
        
        let finalSec = stopTimer();
        let finalMin = finalSec / 60;
        let data6 = buildAffordabilityInput();
        let data7 = buildAffordabilityOutput(
          avgIncome, avgExpenses, avgGambling, avgDisposable,
          gambPctIncome, gambPctDisposable, loanRepayPct,
          finalDecision, finalReason, finalMin
        );
        
        const leadId = document.getElementById("leadId").value.trim();
        debugLog("DEBUG: Initiating final submission decision for Lead ID " + leadId);
        
        // POST the FLG update data without the screenshot first
        debugLog("DEBUG: Posting final decision update to FLG (without screenshot).");
        fetch("https://web-production-15e92.up.railway.app/api/flg_update", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            leadId,
            data6,
            data7,
            data9: "" // Leaving screenshot URL empty for now
          })
        })
        .then(resp => resp.json())
        .then(respData => {
          if (respData.error) {
            showAlert("Error updating FLG: " + respData.error);
            debugLog("DEBUG: FLG update error: " + respData.error);
          } else {
            showAlert("FLG updated successfully (without screenshot)!");
            debugLog("DEBUG: FLG update succeeded.");
          }
        })
        .catch(err => {
          console.error("Error updating FLG:", err);
          showAlert("Error updating FLG. Check console for details.");
          debugLog("DEBUG: Error updating FLG: " + err.message);
        });
        
        // Optionally, if you want to later test the screenshot capture/upload,
        // you can uncomment the code below:
        /*
        debugLog("DEBUG: Capturing screenshot for FLG update.");
        captureScreenshotPDF().then(pdfBlob => {
          debugLog("DEBUG: Screenshot PDF captured.");
          const filename = generateFilename(leadId);
          debugLog("DEBUG: Requesting presigned URL for filename: " + filename);
          return uploadScreenshotSecure(pdfBlob, filename);
        }).then(screenshotUrl => {
          debugLog("DEBUG: Screenshot uploaded successfully. URL: " + screenshotUrl);
          // Optionally, update FLG with the screenshot URL now
          // fetch(... update FLG with data9: screenshotUrl ...)
        }).catch(err => {
          console.error("Screenshot or S3 Upload failed:", err);
          showAlert("Screenshot capture or upload failed. Please try again.");
          debugLog("DEBUG: Screenshot capture/upload error: " + err.message);
        });
        */
      }
      


    /*************************************
     * Session Check
     *************************************/
    function checkSession() {
      fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: 'include' })
        .then(resp => resp.json())
        .then(data => {
          const loginBtn = document.getElementById("loginBtn");
          const fetchDataBtn = document.getElementById("fetchDataBtn");
          if (data.logged_in) {
            loginBtn.innerText = "Logged in with Microsoft 365";
            loginBtn.className = "bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700";
            fetchDataBtn.disabled = false;
            fetchDataBtn.style.backgroundColor = "blue";
          } else {
            loginBtn.innerText = "Log in with Microsoft 365";
            loginBtn.className = "bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700";
            fetchDataBtn.disabled = true;
            fetchDataBtn.style.backgroundColor = "red";
          }
        })
        .catch(err => { console.error("Error checking session status:", err); });
    }
    window.addEventListener("DOMContentLoaded", () => {
      checkSession();
      document.getElementById("timerDisplay").innerText = "Timer: 0:00:00";
    });
  </script>
</head>
<body class="bg-gray-100 p-6">
  <!-- Centered Alert Modal -->
  <div id="alertOverlay"></div>
  <div id="alertBox">
    <div id="alertMessage"></div>
    <button id="alertButton" onclick="closeAlert()">OK</button>
  </div>
  <div class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg">
    <!-- Top bar -->
    <div class="flex justify-between items-center mb-4">
      <button id="returnMenuBtn"
              onclick="window.location.href='https://affordability-review-main-menu.up.railway.app/'"
              class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
        Return to Main Menu
      </button>
      <button id="loginBtn"
              onclick="window.location.href='https://web-production-15e92.up.railway.app/login'"
              class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
        Log in with Microsoft 365
      </button>
    </div>
    <!-- Logo and Title -->
    <div class="text-center mb-4">
      <img src="https://github.com/craigmalenga/Image_belmond_Frontend/blob/main/Belmond%20logo.png?raw=true"
           alt="Company Logo"
           class="h-16 mx-auto mb-2"/>
      <h1 class="text-2xl font-bold">Affordability Assessment</h1>
    </div>
    <!-- Lead ID -->
    <label for="leadId" class="block mt-4 font-medium">Enter Lead ID:</label>
    <div class="flex gap-2 mt-2">
      <input type="text" id="leadId" placeholder="123456789" class="border p-2 flex-1 rounded-md text-gray-600"/>
      <button id="fetchDataBtn" onclick="fetchLeadData()"
              class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-blue-700" disabled>
        Fetch Data
      </button>
    </div>
    <!-- Timer -->
    <div id="timerDisplay" class="mt-4 font-semibold">Timer: 0:00:00</div>
    <!-- Lead Details -->
    <h2 class="text-lg font-semibold mt-6">Lead Details</h2>
    <label class="block mt-2">Full Name:</label>
    <input type="text" id="fullName" class="border p-2 w-full rounded-md bg-gray-200" readonly />
    <label class="block mt-2">Bank Accounts to be Considered:</label>
    <textarea id="bankNames" class="border p-2 w-full rounded-md bg-gray-200" rows="3" readonly></textarea>
    <label class="block mt-2">Period that Bank Statements cover:</label>
    <input type="text" id="periodCovered" class="border p-2 w-full rounded-md bg-gray-200" readonly />
    <label class="block mt-2">Paths to Relevant Bank Statements:</label>
    <textarea id="statement_urls" class="border p-2 w-full rounded-md bg-gray-200" rows="3" readonly></textarea>
    <label class="block mt-2">Monthly Repayments being Assessed for Affordability:</label>
    <input type="number" id="monthlyRepayment" class="border p-2 w-full rounded-md bg-gray-200" readonly />
    <!-- Bank Statements -->
    <h2 class="text-lg font-semibold mt-6">Bank Statements</h2>
    <div id="bankStatements" class="mt-2"></div>
    <!-- Error Container for Warnings & Timer Override -->
    <div id="errorContainer"></div>
    <!-- Statement Form (final summary and decision will be inserted here) -->
    <div id="statementForm"></div>
    <!-- Process Data Button -->
    <button id="processDataBtn"
            class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 w-full"
            disabled
            onclick="processFinalData()">
      Process Data
    </button>
    <!-- Debug Output Area -->
    <div id="debugOutput"></div>
  </div>
</body>
</html>
