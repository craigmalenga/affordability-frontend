<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SharePoint → AWS Uploader</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="manifest" href="/site.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #2E2F43 0%, #2E2F43 85%, #5D2C6D 100%);
      background-size: cover;
    }
    #progressLog, #failedLeads {
      white-space: pre-line;
      padding: 1rem;
      border-radius: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9rem;
      margin-top: 1rem;
      border: 1px solid;
    }
    #progressLog {
      background: #e0f7fa;
      color: #006064;
      border-color: #4dd0e1;
    }
    #failedLeads {
      background: #ffebee;
      color: #b71c1c;
      border-color: #f44336;
    }
    #notLoggedInWarning {
      display: none;
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: #fef2f2;
      color: #b91c1c;
      border: 1px solid #f87171;
      border-radius: 0.5rem;
      text-align: left;
    }
    .fixed-bottom-right-logo {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 100px;
      height: auto;
    }
    /* Updated styles for the text container */
    #textContainer {
      margin-top: 50px;  /* 50px from the top */
      font-size: 1.2rem; /* Bigger font size */
      color: #ffffff;
      text-align: left;
      padding-left: 20px;
      max-width: 90%;
      margin-bottom: 50px;
    }
    #textContainer h2 {
      font-size: 2rem; /* Increased header font size */
      font-weight: bold;
      margin-bottom: 1rem;
    }
    #textContainer p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    #portalBox {
      position: absolute;
      bottom: 100px;
      width: 90%;
      margin-left: 5%;
      background-color: white;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
  </style>
  <script defer>
    async function updateLoginButton() {
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: "include" });
        const data = await resp.json();
        const loginBtn = document.getElementById("loginBtn");
        if (data.logged_in) {
          loginBtn.innerText = "Logged in";
          loginBtn.classList.remove("bg-red-600");
          loginBtn.classList.add("bg-green-600");
        } else {
          loginBtn.innerText = "Log in with Microsoft 365";
          loginBtn.classList.remove("bg-green-600");
          loginBtn.classList.add("bg-red-600");
        }
      } catch (error) {
        console.error("Error updating login button:", error);
      }
    }

    async function checkSession() {
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: "include" });
        const data = await resp.json();
        if (!data.logged_in) {
          document.getElementById("notLoggedInWarning").style.display = "block";
          document.getElementById("listFilesBtn").disabled = true;
          document.getElementById("filesBtn").disabled = true;
        } else {
          document.getElementById("notLoggedInWarning").style.display = "none";
          document.getElementById("listFilesBtn").disabled = false;
          document.getElementById("filesBtn").disabled = false;
        }
        updateLoginButton();
      } catch (err) {
        console.error("Error checking session:", err);
      }
    }

    function logProgress(msg) {
      console.log(msg);
      const progDiv = document.getElementById("progressLog");
      progDiv.innerText += msg + "\n";
    }

    function logFailed(msg) {
      console.error(msg);
      const failedDiv = document.getElementById("failedLeads");
      failedDiv.innerText += msg + "\n";
    }

    window.addEventListener("DOMContentLoaded", () => {
      checkSession();
    });

    async function handleListFiles() {
      const folderLink = document.getElementById("folderLink").value.trim();
      if (!folderLink) {
        alert("Please paste your SharePoint folder link.");
        return;
      }
      logProgress("Listing files from: " + folderLink);
      const listUrl = "https://web-production-15e92.up.railway.app/list-files?folderLink=" + encodeURIComponent(folderLink);
      try {
        const response = await fetch(listUrl, { credentials: "include" });
        if (!response.ok) {
          const err = await response.json();
          logProgress("Error: " + JSON.stringify(err));
          throw new Error("File listing failed.");
        }
        const data = await response.json();
        if (!data.value || !Array.isArray(data.value)) throw new Error("No files returned.");

        renderFileList(data.value);
        logProgress(`Found ${data.value.length} file(s).`);
        aggregateFLGData(data.value);
      } catch (error) {
        logProgress("Error listing files: " + error);
        alert("Error listing files. See progress log for details.");
      }
    }

    function renderFileList(files) {
      const container = document.getElementById("filesContainer");
      container.innerHTML = "";
      files.forEach(file => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-100 rounded my-1 text-left";
        div.innerText = file.name;
        container.appendChild(div);
      });
    }

    function generateRandom9Digit() {
      const num = Math.floor(1 + Math.random() * 999999999); // from 1 to 999999999
      return String(num).padStart(9, "0");
    }

    const S3_BASE_URL = "https://affordability-statememts.s3.eu-north-1.amazonaws.com/";

    function aggregateFLGData(files) {
      const groups = {};  // valid files grouped by LeadID
      const failed = [];  // array of error messages

      files.forEach(file => {
        let originalFilename = file.name;
        let filename = originalFilename;
        if (filename.toLowerCase().endsWith(".pdf")) {
          filename = filename.slice(0, -4);
        }
        const parts = filename.split("-");
        if (parts.length !== 4) {
          failed.push(`File "${originalFilename}" not named according to format (expected 4 parts).`);
          return;
        }
        const leadId = parts[0];
        const bankName = parts[1];
        const datePart = parts[2];
        const accountNumber = parts[3];

        if (!/^[A-Za-z]{3}\d{4}$/.test(datePart)) {
          failed.push(`File "${originalFilename}" has invalid date part "${datePart}" (expected format MmmYYYY).`);
          return;
        }

        const randomDigits = generateRandom9Digit();
        const finalS3Filename = `${leadId}-${bankName}-${datePart}-${accountNumber}-${randomDigits}.pdf`;
        const finalS3Url = `${S3_BASE_URL}${finalS3Filename}`;

        if (!groups[leadId]) {
          groups[leadId] = {
            data8: [],
            data12: datePart,
            data16: []
          };
        } else {
          if (groups[leadId].data12 !== datePart) {
            failed.push(`Inconsistent date for LeadID "${leadId}": "${groups[leadId].data12}" vs. "${datePart}".`);
            delete groups[leadId];
            return;
          }
        }
        groups[leadId].data8.push(finalS3Url);
        groups[leadId].data16.push(`${bankName}-${accountNumber}`);
      });

      const extractedContainer = document.getElementById("extractedData");
      extractedContainer.innerHTML = "<h3 class='font-bold mb-2'>Aggregated FLG Data Fields (Valid LeadIDs):</h3>";
      const aggregated = [];
      for (const leadId in groups) {
        aggregated.push({
          leadId: leadId,
          data8: groups[leadId].data8.join(","),
          data12: groups[leadId].data12,
          data16: groups[leadId].data16.join(",")
        });
      }
      aggregated.forEach(item => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-200 rounded my-1 text-left";
        div.innerHTML = `<strong>Lead ID:</strong> ${item.leadId} <br/>
                         <strong>data8 (S3 URLs):</strong> ${item.data8} <br/>
                         <strong>data12 (Date):</strong> ${item.data12} <br/>
                         <strong>data16 (Bank Info):</strong> ${item.data16}`;
        extractedContainer.appendChild(div);
      });

      const failedContainer = document.getElementById("failedLeads");
      failedContainer.innerHTML = "<h3 class='font-bold mb-2'>Failed Files / LeadIDs:</h3>";
      if (failed.length === 0) {
        failedContainer.innerHTML += "None.";
      } else {
        failed.forEach(msg => {
          const div = document.createElement("div");
          div.className = "p-2 bg-red-100 rounded my-1 text-left";
          div.innerText = msg;
          failedContainer.appendChild(div);
        });
      }
      logProgress("Aggregated FLG data generated for " + aggregated.length + " valid Lead IDs.");
      if (failed.length > 0) {
        logProgress("Some files/LeadIDs failed processing. See failed list below.");
      }
    }

    async function uploadFilesToS3() {
      const folderLink = document.getElementById("folderLink").value.trim();
      if (!folderLink) {
        alert("Please paste your SharePoint folder link.");
        return;
      }
      logProgress("Uploading files to AWS S3 from folder: " + folderLink);
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/upload-to-s3", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ folderLink })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error || "S3 upload failed.");
        logProgress("S3 upload result: " + JSON.stringify(result, null, 2));
      } catch (err) {
        logProgress("Error uploading files to AWS S3: " + err);
        alert("Error uploading files. See progress log for details.");
      }
    }
  </script>
</head>
<body>
  <!-- Top bar with unified login button -->
  <div class="w-full" style="background-color: #D12472;">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center">
        <img src="https://raw.githubusercontent.com/craigmalenga/affordability-frontend/main/O%20logo.png" alt="O-logo" class="h-8 w-auto mr-4" />
        <span class="text-white text-2xl font-bold">BELMOND</span>
      </div>
      <button id="loginBtn" onclick="window.location.href='https://web-production-15e92.up.railway.app/login?state=' + encodeURIComponent(window.location.href)"
              class="text-white px-4 py-2 rounded-md hover:opacity-90">
      </button>
    </div>
  </div>

  <!-- Text container with updated message -->
  <div id="textContainer">
    <h2>Our daily efforts truly make a difference.</h2>
    <p>The data we process is more than just numbers—it embodies genuine impact on individuals in our community, especially those who may be most at risk.</p>
    <p>Every piece of information you handle carries the trust of someone who depends on our support, helping to secure the fair outcomes our clients deserve.</p>
    <p>Thank you for your commitment.</p>
  </div>

  <div id="portalBox">
    <h3 class="text-xl font-bold mb-4">Affordability Assessment Portal</h3>
    <button id="listFilesBtn" onclick="handleListFiles()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
      List Files (SharePoint)
    </button>
    <div id="filesContainer" class="mt-2 w-full"></div>
    <button id="filesBtn" onclick="uploadFilesToS3()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
      Upload Files to AWS S3
    </button>
  </div>

  <!-- Container for progress log -->
  <div id="progressLog"></div>
  <!-- Container for aggregated FLG data -->
  <div id="extractedData" class="mt-4 w-full"></div>
  <!-- Container for failed files/LeadIDs -->
  <div id="failedLeads" class="mt-4 w-full"></div>
  
  <!-- Fixed logo in bottom-right corner -->
  <img src="https://raw.githubusercontent.com/craigmalenga/affordability-frontend/main/O%20logo.png" alt="O-logo" class="fixed-bottom-right-logo" />
</body>
</html>
