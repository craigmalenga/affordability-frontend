<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SharePoint â†’ AWS Uploader</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="manifest" href="/site.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      /* Blue to pink gradient background */
      background: linear-gradient(to bottom right, #5D2C6D 0%, #2E2F43 20%, #2E2F43 100%);
      background-size: cover;
    }
    #progressLog {
      white-space: pre-line;
      background: #e0f7fa;
      padding: 1rem;
      border-radius: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9rem;
      color: #006064;
      margin-top: 1rem;
      border: 1px solid #4dd0e1;
    }
    #notLoggedInWarning {
      display: none;
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: #fef2f2;
      color: #b91c1c;
      border: 1px solid #f87171;
      border-radius: 0.5rem;
      text-align: left;
    }
    .fixed-bottom-right-logo {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 100px;
      height: auto;
    }
  </style>
  <script defer>
    async function updateLoginButton() {
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: "include" });
        const data = await resp.json();
        const loginBtn = document.getElementById("loginBtn");
        if (data.logged_in) {
          loginBtn.innerText = "Logged in";
          loginBtn.classList.remove("bg-red-600");
          loginBtn.classList.add("bg-green-600");
        } else {
          loginBtn.innerText = "Log in with Microsoft 365";
          loginBtn.classList.remove("bg-green-600");
          loginBtn.classList.add("bg-red-600");
        }
      } catch (error) {
        console.error("Error updating login button:", error);
      }
    }
    async function checkSession() {
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/session_status", { credentials: "include" });
        const data = await resp.json();
        if (!data.logged_in) {
          document.getElementById("notLoggedInWarning").style.display = "block";
          document.getElementById("listFilesBtn").disabled = true;
          document.getElementById("extractBtn").disabled = true;
          document.getElementById("flgBtn").disabled = true;
          document.getElementById("filesBtn").disabled = true;
        } else {
          document.getElementById("notLoggedInWarning").style.display = "none";
          document.getElementById("listFilesBtn").disabled = false;
          document.getElementById("extractBtn").disabled = false;
          document.getElementById("flgBtn").disabled = false;
          document.getElementById("filesBtn").disabled = false;
        }
        updateLoginButton();
      } catch (err) {
        console.error("Error checking session:", err);
      }
    }
    function logProgress(msg) {
      console.log(msg);
      const progDiv = document.getElementById("progressLog");
      progDiv.innerText += msg + "\n";
    }
    window.addEventListener("DOMContentLoaded", () => {
      checkSession();
    });
    // For "List Files" button (optional)
    async function handleListFiles() {
      const folderLink = document.getElementById("folderLink").value.trim();
      if (!folderLink) {
        alert("Please paste your SharePoint folder link.");
        return;
      }
      logProgress("Listing files from: " + folderLink);
      const listUrl = "https://web-production-15e92.up.railway.app/list-files?folderLink=" + encodeURIComponent(folderLink);
      try {
        const response = await fetch(listUrl, { credentials: "include" });
        if (!response.ok) {
          const err = await response.json();
          logProgress("Error: " + JSON.stringify(err));
          throw new Error("File listing failed.");
        }
        const data = await response.json();
        if (!data.value || !Array.isArray(data.value)) throw new Error("No files returned.");
        // Optionally, display file names
        const container = document.getElementById("filesContainer");
        container.innerHTML = "";
        data.value.forEach(file => {
          const div = document.createElement("div");
          div.className = "p-2 bg-gray-100 rounded my-1 text-left";
          div.innerText = file.name;
          container.appendChild(div);
        });
        logProgress(`Found ${data.value.length} file(s).`);
      } catch (error) {
        logProgress("Error listing files: " + error);
        alert("Error listing files. See progress log for details.");
      }
    }
    // This function calls a new endpoint to extract FLG fields from filenames.
    async function extractFLGData() {
      const folderLink = document.getElementById("folderLink").value.trim();
      if (!folderLink) {
        alert("Please paste your SharePoint folder link.");
        return;
      }
      logProgress("Extracting FLG data from filenames in folder: " + folderLink);
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/extract-flg-data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ folderLink })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error || "Extraction failed.");
        logProgress("Extraction complete. Planned FLG fields per Lead:");
        logProgress(JSON.stringify(result, null, 2));
      } catch (err) {
        logProgress("Error extracting FLG data: " + err);
        alert("Error extracting FLG data. See progress log for details.");
      }
    }
    // This function calls the endpoint to upload FLG fields only.
    async function uploadFLGFields() {
      // For simplicity, we assume the user enters a Lead ID and the planned fields manually
      const leadId = document.getElementById("leadId").value.trim();
      const data8 = document.getElementById("data8").value.trim();
      const data12 = document.getElementById("data12").value.trim();
      const data16 = document.getElementById("data16").value.trim();
      if (!leadId || !data8 || !data12 || !data16) {
        alert("Please enter Lead ID and all planned FLG field values.");
        return;
      }
      logProgress("Uploading FLG fields for Lead " + leadId);
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/upload-flg-fields", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ leadId, data8, data12, data16 })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error || "FLG upload failed.");
        logProgress("FLG upload result: " + JSON.stringify(result, null, 2));
      } catch (err) {
        logProgress("Error uploading FLG fields: " + err);
        alert("Error uploading FLG fields. See progress log for details.");
      }
    }
    // This function calls the endpoint to upload files to AWS S3.
    async function uploadFilesToS3() {
      const folderLink = document.getElementById("folderLink").value.trim();
      if (!folderLink) {
        alert("Please paste your SharePoint folder link.");
        return;
      }
      logProgress("Uploading files to AWS S3 from folder: " + folderLink);
      try {
        const resp = await fetch("https://web-production-15e92.up.railway.app/upload-to-s3", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ folderLink })
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error || "S3 upload failed.");
        logProgress("S3 upload result: " + JSON.stringify(result, null, 2));
      } catch (err) {
        logProgress("Error uploading files to AWS S3: " + err);
        alert("Error uploading files. See progress log for details.");
      }
    }
  </script>
</head>
<body>
  <!-- Top bar with unified login button -->
  <div class="w-full" style="background-color: #D12472;">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center">
        <img src="https://raw.githubusercontent.com/craigmalenga/affordability-frontend/main/O%20logo.png" alt="O-logo" class="h-8 w-auto mr-4" />
        <span class="text-white text-2xl font-bold">BELMOND</span>
      </div>
      <button id="loginBtn" onclick="window.location.href='https://web-production-15e92.up.railway.app/login?state=' + encodeURIComponent(window.location.href)"
              class="text-white px-4 py-2 rounded-md hover:opacity-90">
      </button>
    </div>
  </div>
  <div class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg text-center mt-10 mb-10">
    <div id="notLoggedInWarning">
      <p><strong>Warning:</strong> You are not logged in to Microsoft 365. Please log in using the button above.</p>
    </div>
    <img src="https://github.com/craigmalenga/affordability-frontend/blob/main/logo.png?raw=true" alt="Company Logo" class="h-16 mx-auto mb-4" />
    <h1 class="text-2xl font-bold mb-4">SharePoint to AWS Uploader</h1>
    <div class="mb-4">
      <label for="folderLink" class="block font-medium mb-2">Paste SharePoint Folder Link:</label>
      <input type="text" id="folderLink" placeholder="https://yoursharepointurl" class="border p-2 rounded-md w-full" />
    </div>
    <div class="flex flex-col gap-4 items-center">
      <button id="listFilesBtn" onclick="handleListFiles()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
        List Files (SharePoint)
      </button>
      <div id="filesContainer" class="mt-2 w-full"></div>
      <button id="extractBtn" onclick="handleProcessFiles('extract')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
        Extract FLG Data from File Names
      </button>
      <button id="flgBtn" onclick="uploadFLGFields()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
        Upload Info to FLG
      </button>
      <button id="filesBtn" onclick="uploadFilesToS3()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
        Upload Files to AWS S3
      </button>
    </div>
    <!-- Visible progress log area -->
    <div id="progressLog"></div>
  </div>
  <!-- Fixed logo in bottom-right corner -->
  <img src="https://raw.githubusercontent.com/craigmalenga/affordability-frontend/main/O%20logo.png" alt="O-logo" class="fixed-bottom-right-logo" />
</body>
</html>
