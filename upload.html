<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Affordability Assessment</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url("https://github.com/craigmalenga/affordability-frontend/blob/main/Background.png?raw=true") no-repeat center center fixed;
      background-size: cover;
    }

    #errorContainer, #bankWarningsDiv, #timerOverrideDiv {
      width: 100%;
    }

    .warning-box, .time-box, .decision-box {
      width: 100%;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .warning-box {
      border: 1px solid #f87171;
      background-color: #fef2f2;
      color: #b91c1c;
    }

    .time-box {
      border: 1px solid #facc15;
      background-color: #fefce8;
      color: #b45309;
    }

    .decision-box {
      border: 1px solid #3b82f6;
      background-color: #dbeafe;
      color: #1e3a8a;
    }

    #alertOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
    }

    #alertBox {
      display: none;
      position: fixed;
      width: 300px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #aaa;
      border-radius: 8px;
      padding: 20px;
      z-index: 1000;
      text-align: center;
    }

    #alertMessage {
      margin-bottom: 1rem;
    }

    #alertButton {
      background: #3490dc;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #alertButton:hover {
      background: #2779bd;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .summary-table th, .summary-table td {
      border: 1px solid #ccc;
      padding: 8px;
    }

    .summary-table th {
      background-color: #f9f9f9;
      text-align: left;
    }

    #debugOutput {
      margin-top: 1rem;
      padding: 8px;
      background-color: #fff;
      border: 1px solid #a0aec0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
  <script>
    function debugLog(msg) {
      console.debug(msg);
    }

    function showProcessing() {
      const overlay = document.getElementById("alertOverlay");
      const alertBox = document.getElementById("alertBox");
      const alertMessage = document.getElementById("alertMessage");
      const alertButton = document.getElementById("alertButton");

      alertMessage.innerText = "Processing... Please wait.";
      alertButton.style.display = "none"; // Hide the OK button during processing
      overlay.style.display = "block";
      alertBox.style.display = "block";
    }

    function hideProcessing() {
      const overlay = document.getElementById("alertOverlay");
      const alertBox = document.getElementById("alertBox");
      const alertButton = document.getElementById("alertButton");

      overlay.style.display = "none";
      alertBox.style.display = "none";
      alertButton.style.display = "block"; // Restore OK button
    }

    function captureScreenshotPDF() {
      debugLog("DEBUG: Starting screenshot capture using html2canvas with improved scale.");
      const content = document.getElementById("pdfContent");

      return html2canvas(content, {
        scrollY: -window.scrollY,
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight,
        useCORS: true,
        scale: 3
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png', 1.0);
        debugLog("DEBUG: Screenshot captured, converting to multi-page PDF.");
        const { jsPDF } = window.jspdf;

        let pdf = new jsPDF('p', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth;
        const imgHeight = (canvas.height * pdfWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pdfHeight;
        }

        debugLog("DEBUG: Multi-page PDF generated successfully.");
        return pdf.output('blob');
      });
    }

    function generateFilename(leadId) {
      const randomNum = Math.floor(100000000 + Math.random() * 900000000);
      const now = new Date();
      const day = now.getDate().toString().padStart(2, '0');
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const month = monthNames[now.getMonth()];
      const year = now.getFullYear().toString().substr(-2);

      const filename = `affordability_decision_screenshot-${leadId}-${randomNum}-${day}${month}${year}.pdf`;
      debugLog("DEBUG: Generated filename: " + filename);
      return filename;
    }

    function uploadScreenshotSecure(pdfBlob, filename) {
      return fetch(
        `https://web-production-15e92.up.railway.app/api/generate_presigned_url?filename=${encodeURIComponent(filename)}`,
        { credentials: "include" }
      )
      .then(resp => resp.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        const presignedUrl = data.presigned_url;
        const publicUrl = data.public_url;

        debugLog("DEBUG: Obtained presigned URL: " + presignedUrl);

        return fetch(presignedUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/pdf" },
          body: pdfBlob
        }).then(uploadResp => {
          if (uploadResp.ok) {
            debugLog("DEBUG: S3 upload succeeded. Permanent URL: " + publicUrl);
            return publicUrl;
          } else {
            debugLog("DEBUG: S3 upload failed with status " + uploadResp.status);
            throw new Error("S3 Upload failed");
          }
        });
      });
    }
  </script>
</head>

<body class="bg-gray-100 p-6">
  <div id="alertOverlay"></div>
  <div id="alertBox">
    <div id="alertMessage"></div>
    <button id="alertButton" onclick="closeAlert()">OK</button>
  </div>

  <div id="pdfContent" class="max-w-3xl mx-auto bg-white p-6 shadow-md rounded-lg">
    <div class="flex justify-between items-center mb-4">
      <button id="returnMenuBtn" onclick="window.location.href='https://affordability-review-main-menu.up.railway.app/'"
        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
        Return to Main Menu
      </button>
      <button id="loginBtn" onclick="window.location.href='https://web-production-15e92.up.railway.app/login'"
        class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
        Log in with Microsoft 365
      </button>
    </div>

    <div class="text-center mb-4">
      <img src="https://github.com/craigmalenga/Image_belmond_Frontend/blob/main/Belmond%20logo.png?raw=true"
        alt="Company Logo" class="h-16 mx-auto mb-2" />
      <h1 class="text-2xl font-bold">Affordability Assessment</h1>
    </div>

    <label for="leadId" class="block mt-4 font-medium">Enter Lead ID:</label>
    <div class="flex gap-2 mt-2">
      <input type="text" id="leadId" placeholder="123456789" class="border p-2 flex-1 rounded-md text-gray-600" />
      <button id="fetchDataBtn" onclick="fetchLeadData()"
        class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-blue-700" disabled>Fetch Data</button>
    </div>

    <div id="timerDisplay" class="mt-4 font-semibold">Timer: 0:00:00</div>

    <h2 class="text-lg font-semibold mt-6">Lead Details</h2>
    <label class="block mt-2">Full Name:</label>
    <input type="text" id="fullName" class="border p-2 w-full rounded-md bg-gray-200" readonly />

    <label class="block mt-2">Bank Accounts to be Considered:</label>
    <textarea id="bankNames" class="border p-2 w-full rounded-md bg-gray-200" rows="3" readonly></textarea>

    <label class="block mt-2">Period that Bank Statements cover:</label>
    <input type="text" id="periodCovered" class="border p-2 w-full rounded-md bg-gray-200" readonly />

    <div class="hidden">
      <label class="block mt-2">Paths to Relevant Bank Statements:</label>
      <textarea id="statement_urls" class="border p-2 w-full rounded-md bg-gray-200" rows="3" readonly></textarea>
    </div>

    <label class="block mt-2">Monthly Repayments being Assessed for Affordability:</label>
    <input type="number" id="monthlyRepayment" class="border p-2 w-full rounded-md bg-gray-200" readonly />

    <h2 class="text-lg font-semibold mt-6">Bank Statements</h2>
    <div id="bankStatements" class="mt-2"></div>

    <div id="errorContainer"></div>
    <div id="statementForm"></div>

    <button id="processDataBtn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 w-full"
      disabled onclick="processFinalData()">Process Data</button>

    <div id="debugOutput"></div>
  </div>

  <div id="processingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(255,255,255,0.8); z-index:9999; text-align:center;">
    <div style="position:relative; top:40%; font-size:1.5rem; font-weight:bold; color:#333;">
      Processing your submission, please wait...
    </div>
  </div>
</body>
</html>
